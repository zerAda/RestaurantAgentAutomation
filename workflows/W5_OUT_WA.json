{
  "name": "W5 - OUT WhatsApp Sender (Meta Cloud API)",
  "active": false,
  "settings": {
    "executionTimeout": 120,
    "saveExecutionProgress": true,
    "saveManualExecutions": true
  },
  "nodes": [
    {
      "parameters": {},
      "id": "2679a5a9-fe7a-44b0-ad65-f17fa329f6e0",
      "name": "IN - From CORE",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [-2400, 0]
    },
    {
      "parameters": {
        "language": "javascript",
        "jsCode": "/**\n * W5 - WhatsApp Outbound Sender\n * Supports both Mock API (dev) and Meta Cloud API (production)\n * \n * Meta Cloud API format:\n *   POST https://graph.facebook.com/v21.0/{PHONE_NUMBER_ID}/messages\n *   Body: { messaging_product: 'whatsapp', to: 'PHONE', type: 'text', text: { body: 'MSG' } }\n * \n * Input from CORE:\n *   { channel, restaurantId, userId, replyText, buttons, attachments, templateName, templateParams, locale }\n */\n\nconst payload = $json;\nconst timestamp = new Date().toISOString();\n\n// Configuration\nconst sendUrl = ($env.WA_SEND_URL || '').toString().trim();\nconst phoneNumberId = ($env.WA_PHONE_NUMBER_ID || '').toString().trim();\nconst token = ($env.WA_API_TOKEN || '').toString().trim();\n\n// Detect if using Meta Cloud API (production) or mock\nconst isMetaApi = sendUrl.includes('graph.facebook.com') || !!phoneNumberId;\nlet url = sendUrl;\n\nif (!url && phoneNumberId) {\n  // Auto-construct Meta Cloud API URL\n  url = `https://graph.facebook.com/v21.0/${phoneNumberId}/messages`;\n}\n\nif (!url) {\n  return [{ json: { \n    sent: false, \n    error: 'WA_SEND_URL_NOT_SET',\n    reason: 'WA_SEND_URL or WA_PHONE_NUMBER_ID must be configured',\n    timestamp,\n    payload \n  }}];\n}\n\nif (!token) {\n  return [{ json: { \n    sent: false, \n    error: 'WA_API_TOKEN_NOT_SET',\n    reason: 'WA_API_TOKEN must be configured',\n    timestamp,\n    payload \n  }}];\n}\n\nconst recipientPhone = (payload.userId || '').toString().trim();\nif (!recipientPhone) {\n  return [{ json: { \n    sent: false, \n    error: 'RECIPIENT_MISSING',\n    reason: 'userId (phone number) is required',\n    timestamp,\n    payload \n  }}];\n}\n\n// Build request body\nlet body;\nif (isMetaApi) {\n  // Meta Cloud API format\n  const text = (payload.replyText || '').toString().trim();\n  const templateName = (payload.templateName || '').toString().trim();\n  \n  if (templateName) {\n    // Template message (for outbound outside 24h window)\n    const templateParams = Array.isArray(payload.templateParams) ? payload.templateParams : [];\n    const locale = (payload.locale || 'fr').toString();\n    \n    body = {\n      messaging_product: 'whatsapp',\n      recipient_type: 'individual',\n      to: recipientPhone,\n      type: 'template',\n      template: {\n        name: templateName,\n        language: { code: locale === 'ar' ? 'ar' : 'fr' },\n        components: templateParams.length > 0 ? [{\n          type: 'body',\n          parameters: templateParams.map(p => ({ type: 'text', text: String(p) }))\n        }] : undefined\n      }\n    };\n  } else if (Array.isArray(payload.buttons) && payload.buttons.length > 0) {\n    // Interactive message with buttons\n    body = {\n      messaging_product: 'whatsapp',\n      recipient_type: 'individual',\n      to: recipientPhone,\n      type: 'interactive',\n      interactive: {\n        type: 'button',\n        body: { text: text || 'Choose an option:' },\n        action: {\n          buttons: payload.buttons.slice(0, 3).map((btn, i) => ({\n            type: 'reply',\n            reply: {\n              id: btn.id || `btn_${i}`,\n              title: (btn.title || btn.label || '').slice(0, 20)\n            }\n          }))\n        }\n      }\n    };\n  } else {\n    // Simple text message\n    body = {\n      messaging_product: 'whatsapp',\n      recipient_type: 'individual',\n      to: recipientPhone,\n      type: 'text',\n      text: { \n        preview_url: false,\n        body: text || '(empty message)'\n      }\n    };\n  }\n} else {\n  // Mock API format (dev/test)\n  body = {\n    channel: 'whatsapp',\n    to: recipientPhone,\n    restaurantId: payload.restaurantId || '',\n    text: payload.replyText || '',\n    buttons: Array.isArray(payload.buttons) ? payload.buttons : [],\n    attachments: Array.isArray(payload.attachments) ? payload.attachments : []\n  };\n}\n\n// Send request with retry logic\nlet lastError = null;\nlet response = null;\nconst maxRetries = 3;\nconst baseDelay = 1000;\n\nfor (let attempt = 1; attempt <= maxRetries; attempt++) {\n  try {\n    response = await $httpRequest({\n      method: 'POST',\n      url,\n      headers: {\n        'Authorization': `Bearer ${token}`,\n        'Content-Type': 'application/json'\n      },\n      body,\n      json: true,\n      timeout: 30000,\n      returnFullResponse: true\n    });\n    \n    const statusCode = response.statusCode || response.status || 200;\n    \n    // Success\n    if (statusCode >= 200 && statusCode < 300) {\n      const responseBody = response.body || response.data || response;\n      return [{ json: {\n        sent: true,\n        provider: isMetaApi ? 'meta_cloud_api' : 'mock',\n        messageId: responseBody?.messages?.[0]?.id || responseBody?.message_id || null,\n        recipient: recipientPhone,\n        timestamp,\n        attempt,\n        response: responseBody\n      }}];\n    }\n    \n    // Rate limited - wait and retry\n    if (statusCode === 429) {\n      const retryAfter = parseInt(response.headers?.['retry-after'] || '60', 10);\n      lastError = { statusCode, error: 'RATE_LIMITED', retryAfter };\n      if (attempt < maxRetries) {\n        await new Promise(r => setTimeout(r, Math.min(retryAfter * 1000, 60000)));\n        continue;\n      }\n    }\n    \n    // Server error - retry with backoff\n    if (statusCode >= 500) {\n      lastError = { statusCode, error: 'SERVER_ERROR', body: response.body };\n      if (attempt < maxRetries) {\n        await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, attempt - 1)));\n        continue;\n      }\n    }\n    \n    // Client error - don't retry\n    if (statusCode >= 400) {\n      return [{ json: {\n        sent: false,\n        error: 'CLIENT_ERROR',\n        statusCode,\n        provider: isMetaApi ? 'meta_cloud_api' : 'mock',\n        response: response.body || response,\n        timestamp,\n        attempt,\n        requestBody: body\n      }}];\n    }\n    \n  } catch (err) {\n    lastError = { error: 'REQUEST_FAILED', message: err.message };\n    if (attempt < maxRetries) {\n      await new Promise(r => setTimeout(r, baseDelay * Math.pow(2, attempt - 1)));\n      continue;\n    }\n  }\n}\n\n// All retries exhausted\nreturn [{ json: {\n  sent: false,\n  error: 'MAX_RETRIES_EXHAUSTED',\n  lastError,\n  provider: isMetaApi ? 'meta_cloud_api' : 'mock',\n  timestamp,\n  attempts: maxRetries,\n  requestBody: body\n}}];\n"
      },
      "id": "fd8fc539-6895-4732-8b02-3cfd0a3db2ad",
      "name": "OUT - Send Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2150, 0]
    }
  ],
  "connections": {
    "IN - From CORE": {
      "main": [
        [
          {
            "node": "OUT - Send Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}
