{
    "name": "W4_CORE",
    "meta": {
        "instanceId": "core_conversational_bot"
    },
    "settings": {
        "algerianLocalization": {
            "enabled": true,
            "languageDetection": "auto",
            "supportedLanguages": [
                "fr",
                "ar",
                "dz"
            ],
            "codesSwitchingEnabled": true
        }
    },
    "nodes": [
        {
            "parameters": {},
            "name": "Message Input",
            "type": "n8n-nodes-base.start",
            "typeVersion": 1,
            "position": [
                100,
                300
            ]
        },
        {
            "parameters": {
                "operation": "get",
                "collection": "restaurant-brand",
                "id": "singleton"
            },
            "name": "Get Brand Config",
            "type": "n8n-nodes-base.strapi",
            "typeVersion": 1,
            "position": [
                250,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// D√©tection de langue Alg√©rienne\nconst text = $input.first().json.text || '';\nconst brand = $node['Get Brand Config'].json;\n\n// Patterns Darija\nconst darijaPatterns = /\\b(sahit|bsaha|chhal|wesh|khouya|rabi|inchallah|baraka|rabbi yahafdek)\\b/i;\n\n// Patterns Arabe\nconst arabicPattern = /[\\u0600-\\u06FF]/;\n\n// Patterns Fran√ßais\nconst frenchPattern = /\\b(bonjour|merci|salut|commander|livraison)\\b/i;\n\nlet detectedLang = 'fr';\nlet mixedMode = false;\n\nif (arabicPattern.test(text)) {\n  detectedLang = 'ar';\n}\n\nif (darijaPatterns.test(text)) {\n  detectedLang = 'dz';\n  if (frenchPattern.test(text)) {\n    mixedMode = true; // Code-switching FR/Darija\n  }\n}\n\nreturn {\n  json: {\n    ...($input.first().json),\n    detected_language: detectedLang,\n    mixed_mode: mixedMode,\n    brand: brand\n  }\n};"
            },
            "name": "Language Detection (DZ Market)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                400,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://api.openai.com/v1/chat/completions",
                "method": "POST",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "model",
                            "value": "gpt-4"
                        },
                        {
                            "name": "messages",
                            "value": "={{ [\n  {\n    \"role\": \"system\",\n    \"content\": `Tu es l'assistant conversationnel de '${$json.brand.restaurant_name}'.\n\nIDENTIT√â & MARCH√â:\n- March√©: ALG√âRIE (Fran√ßais, Darija, Arabe)\n- Ton: ${$json.brand.voice_tone}\n- Histoire: ${$json.brand.brand_story}\n\nR√àGLES LINGUISTIQUES ALG√âRIENNES:\n1. LANGUE D√âTECT√âE: ${$json.detected_language}\n2. CODE-SWITCHING: ${$json.mixed_mode ? 'OUI - M√©lange naturel FR/Darija autoris√©' : 'NON'}\n3. EXPRESSIONS DARIJA AUTORIS√âES: ${JSON.stringify($json.brand.localization?.darija_expressions || [])}\n4. Si client parle en Darija ‚Üí R√©ponds en Darija/FR naturel\n5. Si client parle en Arabe ‚Üí R√©ponds en Arabe formel\n6. Si client parle en Fran√ßais ‚Üí R√©ponds en Fran√ßais (avec touches Darija si appropri√©)\n\nEXEMPLES DE R√âPONSES:\n- \"Sahit chef ! Chhal bghiti ? üçî\" (Darija)\n- \"Bsaha ! Ta commande arrive dans 20min\" (Mix)\n- \"ŸÖÿ±ÿ≠ÿ®ÿß! ŸÖÿßÿ∞ÿß ÿ™ÿ±ŸäÿØ ÿ£ŸÜ ÿ™ÿ∑ŸÑÿ®ÿü\" (Arabe)\n\nCULTURE ALG√âRIENNE:\n- Utilise \"chef\", \"khouya\" si familier\n- Pendant Ramadan: propose ftour/shour\n- Horaires pri√®re: sois flexible\n\nNE JAMAIS:\n- Forcer une langue si le client en pr√©f√®re une autre\n- Utiliser des expressions fran√ßaises formelles si le client est Darija\n- Ignorer le code-switching naturel\n\nT√ÇCHE: Aide le client √† commander en respectant SA langue et SA culture.`\n  },\n  {\n    \"role\": \"user\",\n    \"content\": $json.text\n  }\n] }}"
                        }
                    ]
                }
            },
            "name": "AI Response (Algerian Tuned)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                600,
                300
            ]
        }
    ],
    "connections": {
        "Message Input": {
            "main": [
                [
                    {
                        "node": "Get Brand Config",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Brand Config": {
            "main": [
                [
                    {
                        "node": "Language Detection (DZ Market)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Language Detection (DZ Market)": {
            "main": [
                [
                    {
                        "node": "AI Response (Algerian Tuned)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}