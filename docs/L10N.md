# EPIC 5 — Langues (P2)

## Objectif
Réponses **FR / AR** avec règle produit:
- **Si le client envoie un message contenant de l’arabe (script Unicode arabe), on répond en AR**
- Sinon on répond en **FR**
- La commande `LANG FR` / `LANG AR` reste supportée pour **enregistrer une préférence** (utile pour les notifications tracking), mais la **réponse interactive** reste pilotée par le **script du message**.

## Feature flag
- `L10N_ENABLED=false` : comportement legacy (réponses inchangées)
- `L10N_ENABLED=true` : activation L10N + détection de script

Variables:
- `L10N_ENABLED` (default `false`) dans `.env` / docker-compose

## Sticky Arabic (optionnel)
Quand `L10N_STICKY_AR_ENABLED=true`, on applique une règle de session:
- On compte le nombre de messages contenant du **script arabe** (stocké dans `state.arabicScriptCount`).
- À partir de `L10N_STICKY_AR_THRESHOLD` (default `2`), `state.stickyAr=true`.
- Tant que `state.stickyAr=true`, si le client écrit en **Darija translit (latin)** (ex: `chno kayn`, `kml`) **sans** utiliser de script arabe, on répond **en AR** pour le reste de la session.

Variables:
- `L10N_STICKY_AR_ENABLED` (default `false`)
- `L10N_STICKY_AR_THRESHOLD` (default `2`)

## Stockage
### message_templates
Table multi-locale pour les messages transactionnels.

Clés seedées:
- `CORE_CLARIFY`
- `CORE_MENU_HEADER`
- `CORE_LANG_SET_FR`
- `CORE_LANG_SET_AR`
- `WA_ORDER_STATUS_*`

Règles de résolution:
- locale demandée (`ar` / `fr`)
- fallback sur `fr` si manquante

### customer_preferences
Préférence locale par client:
- `tenant_id`, `phone`, `locale`
- alimentée via `LANG FR` / `LANG AR`

## Workflows n8n
- `W4_CORE`: 
  - détection du script arabe sur `message.text`
  - `responseLocale = ar` si arabe sinon `fr`
  - `LANG FR/AR` persiste `state.localePref` + `customer_preferences`
  - rendu via templates chargés depuis DB (`message_templates`)

## QA
- `scripts/test_darja_intents.py` (20 phrases Darija → normalisation menu/checkout)
- `scripts/test_template_render.py` (safe rendering)
- Integrity Gate: exécute les tests L10N et vérifie la présence des livrables EPIC5
