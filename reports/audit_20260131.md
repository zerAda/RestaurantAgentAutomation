# AUDIT PROD-READINESS - 2026-01-31

## Résumé Exécutif

| Critère | Status |
|---------|--------|
| **Meta verify GET** | ✓ Ready (W0_META_VERIFY_UNIFIED) |
| **Signature validation** | ✓ Ready (off/warn/enforce, default warn) |
| **DB Migrations** | ✓ Fixed (P0-01: db-migrate service) |
| **Rate Limiting** | ✓ Fixed (P0-02: zone=meta_inbound) |
| **Config Consistency** | ✓ Fixed (P0-03: docs aligned) |
| **Mock-API Defaults** | ✓ Fixed (P0-04: fail-fast if not configured) |

---

## 1. INVENTAIRE WORKFLOWS

| ID | Fichier | Fonction | Status |
|----|---------|----------|--------|
| W0 | META_VERIFY_UNIFIED.json | Webhook verify GET | ✓ |
| W0 | REDIS_HELPER.json | Redis ops | ✓ |
| W1 | IN_WA.json | WhatsApp inbound | ✓ |
| W2 | IN_IG.json | Instagram inbound | ✓ |
| W3 | IN_MSG.json | Messenger inbound | ✓ |
| W4 | CORE.json | Orchestration | ✓ |
| W5 | OUT_WA.json | WhatsApp outbound | ✓ |
| W6 | OUT_IG.json | Instagram outbound | ✓ |
| W7 | OUT_MSG.json | Messenger outbound | ✓ |
| W8 | OPS.json, DLQ_*.json | Operations + DLQ | ✓ |
| W9 | ADMIN_PING.json | Scope test | ✓ |
| W10 | CUSTOMER_DELIVERY_QUOTE.json | Delivery quote | ✓ |
| W11 | ADMIN_DELIVERY_ZONES.json | Zone mgmt | ✓ |
| W12 | ADMIN_ORDERS.json | Order mgmt | ✓ |
| W14 | ADMIN_WA_SUPPORT_CONSOLE.json | Admin WA | ✓ |
| W15 | OUTBOX_WORKER.json | Outbox retry | ✓ |
| W16 | HEALTHZ.json | Health check | ✓ |
| W17 | HEALTH_MONITOR.json | Scheduled health | ✓ |
| W18 | MEDIA_FETCH_WORKER.json | Media fetch | ✓ |

**Total: 21 workflows actifs**

---

## 2. BASE DE DONNÉES

### Schema
- `db/bootstrap.sql` - Schéma de base complet
- `db/migrations/` - 25 migrations idempotentes

### Migration System (P0-01 FIXED)
- ✓ Service `db-migrate` dans docker-compose
- ✓ Table `schema_migrations` pour tracking
- ✓ n8n dépend de `db-migrate: service_completed_successfully`
- ✓ Script `scripts/db_migrate_all.sh` pour migration manuelle

### Tables Critiques
| Table | Migration | Usage |
|-------|-----------|-------|
| `tenants`, `restaurants` | bootstrap | Multi-tenant |
| `api_clients` | bootstrap | Auth tokens |
| `delivery_zones` | p2_epic2_delivery | Livraison |
| `support_tickets` | p2_epic6_support | Support |
| `admin_wa_audit_log` | p0_sup01_admin_wa_audit | Audit |

---

## 3. SÉCURITÉ

### Signature Meta (P0-03 FIXED)
```
META_SIGNATURE_REQUIRED=${META_SIGNATURE_REQUIRED:-warn}
```
- ✓ `off` = skip (dev)
- ✓ `warn` = log failures, allow through (default)
- ✓ `enforce` = reject invalid (PROD)

### Rate Limiting (P0-02 FIXED)
```nginx
# Meta inbound - keyed by IP (Meta doesn't send tokens)
limit_req_zone $binary_remote_addr zone=meta_inbound:10m rate=10r/s;

# Internal API - keyed by token
limit_req_zone $http_x_api_token zone=internal_token:10m rate=20r/s;
```

### Token Security
- ✓ `ALLOW_QUERY_TOKEN=false` par défaut
- ✓ `LEGACY_SHARED_ALLOWED=false` par défaut
- ✓ Tokens stockés hashés (sha256) dans `api_clients`

---

## 4. P0-04 MOCK-API DEFAULTS - FIXED

### Problème Original
Dans `docker-compose.hostinger.prod.yml`:
```yaml
# AVANT (DANGEREUX)
- WA_SEND_URL=${WA_SEND_URL:-http://mock-api:8080/send/wa}
```

### Solution Appliquée
```yaml
# APRÈS (FAIL-FAST)
- WA_SEND_URL=${WA_SEND_URL:?WA_SEND_URL must be set for production}
```

La syntaxe `${VAR:?message}` fait que docker-compose **échoue au démarrage** si la variable n'est pas définie.

### Résultat
- ✓ Si env vars manquantes: déploiement échoue avec message clair
- ✓ Plus de perte de messages silencieuse
- ✓ STT reste optionnel (default vide = désactivé)

---

## 5. CONFIGURATION

### Variables Critiques PRODUCTION
| Variable | Requis | Status |
|----------|--------|--------|
| `WA_SEND_URL` | ✓ | ❌ Default mock-api |
| `WA_API_TOKEN` | ✓ | OK (pas de default) |
| `IG_SEND_URL` | ✓ | ❌ Default mock-api |
| `IG_API_TOKEN` | ✓ | OK (pas de default) |
| `MSG_SEND_URL` | ✓ | ❌ Default mock-api |
| `MSG_API_TOKEN` | ✓ | OK (pas de default) |
| `META_APP_SECRET` | ✓ | OK (pas de default) |
| `DATABASE_URL` | ✓ | OK |
| `REDIS_URL` | ✓ | OK |

---

## 6. CI/CD

### GitHub Actions
- ✓ `health-monitor.yml` - Health check every 6h
- ✓ `scheduled-backup.yml` - Daily backup 3AM UTC
- ✓ `security-scan.yml` - Security scanning

### Scripts de Validation
- `scripts/smoke.sh` - Tests basiques
- `scripts/smoke_meta.sh` - Tests Meta spécifiques
- `scripts/test_battery.sh` - 100 tests
- `scripts/integrity_gate.sh` - Pre-commit checks

---

## 7. TICKETS P0 STATUS

| ID | Description | Status |
|----|-------------|--------|
| P0-01 | DB Migrations | ✓ FIXED |
| P0-02 | Rate Limit Meta | ✓ FIXED |
| P0-03 | Signature Config | ✓ FIXED |
| P0-04 | Mock-API Defaults | ✓ FIXED |

**Tous les P0 sont résolus.**

---

## 7.1 TICKETS P1 STATUS

| ID | Description | Status |
|----|-------------|--------|
| P1-01 | Real Meta Fixtures + Smoke Harness | ✓ FIXED |

### P1-01 Solution

**Problème:** Scripts de test utilisaient payload canonique interne, pas le format natif Meta.

**Solution:**
- Créé `scripts/smoke/payloads/` avec 12 fixtures JSON natifs:
  - WhatsApp: `wa_text.json`, `wa_image.json`, `wa_button_reply.json`, `wa_list_reply.json`
  - Instagram: `ig_text.json`, `ig_image.json`, `ig_postback.json`, `ig_story_mention.json`
  - Messenger: `msg_text.json`, `msg_image.json`, `msg_postback.json`, `msg_quick_reply.json`
- Créé `scripts/smoke/run.sh` avec 8 sections:
  1. Healthcheck
  2. GET Verify (3 canaux)
  3. POST Native WhatsApp
  4. POST Native Instagram
  5. POST Native Messenger
  6. Signature Validation
  7. Idempotence
  8. Anti-Replay

---

## 8. RECOMMANDATIONS

### Immédiat (Avant Go-Live)
1. Configurer toutes les variables PRODUCTION dans `.env`
2. Mettre `META_SIGNATURE_REQUIRED=enforce`
3. Vérifier les tokens Meta API (WA/IG/MSG)

### Court Terme
1. Ajouter un preflight check qui valide les env vars requises
2. Créer des alertes si outbound échoue

### Documentation
- ✓ `docs/RUNBOOK.md` mis à jour
- ✓ `docs/API_CONVENTIONS.md` clarifié
- ✓ `docs/CICD_RUNBOOK.md` créé

---

## CONCLUSION

**Status: READY FOR PRODUCTION**

Tous les tickets P0 sont résolus:
- ✓ P0-01: DB migrations automatiques
- ✓ P0-02: Rate limiting correct pour Meta
- ✓ P0-03: Configuration signature cohérente
- ✓ P0-04: Fail-fast si outbound URLs non configurées

### Checklist Go-Live
- [ ] Configurer `.env` avec vraies valeurs (tokens Meta, URLs Graph API)
- [ ] Mettre `META_SIGNATURE_REQUIRED=enforce`
- [ ] Exécuter `./scripts/smoke.sh` et `./scripts/smoke_meta.sh`
- [ ] Vérifier les backups (scheduled-backup workflow)
