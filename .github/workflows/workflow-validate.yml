# =============================================================================
# Workflow Validate - Resto Bot
# =============================================================================
# Validates n8n workflow JSON files:
# - JSON syntax validation
# - Required fields check (name, nodes, connections, active)
# - Naming convention enforcement (W<N>_*.json)
# - Hardcoded IP detection (warning)
# - Execute Command node detection (warning)
# =============================================================================

name: Workflow Validate

on:
  pull_request:
    paths:
      - 'workflows/*.json'
  push:
    paths:
      - 'workflows/*.json'

permissions:
  contents: read

jobs:
  validate-workflows:
    name: Validate Workflow Files
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate JSON syntax
        run: |
          echo "::group::JSON syntax validation"
          ERRORS=0

          for wf in workflows/*.json; do
            [[ -f "$wf" ]] || continue
            if node -e "JSON.parse(require('fs').readFileSync('$wf', 'utf8'));" 2>/dev/null; then
              echo "OK: $wf"
            else
              echo "::error file=$wf::Invalid JSON syntax"
              ERRORS=1
            fi
          done

          if [[ $ERRORS -eq 1 ]]; then
            exit 1
          fi
          echo "::endgroup::"

      - name: Validate required fields
        run: |
          echo "::group::Required fields validation"
          ERRORS=0

          for wf in workflows/*.json; do
            [[ -f "$wf" ]] || continue
            if jq -e '.name and .nodes and .connections and .active' "$wf" > /dev/null 2>&1; then
              echo "OK: $wf"
            else
              echo "::error file=$wf::Missing required fields (name, nodes, connections, active)"
              ERRORS=1
            fi
          done

          if [[ $ERRORS -eq 1 ]]; then
            exit 1
          fi
          echo "::endgroup::"

      - name: Validate naming convention
        run: |
          echo "::group::Naming convention check"
          ERRORS=0

          for wf in workflows/*.json; do
            [[ -f "$wf" ]] || continue
            BASENAME=$(basename "$wf")
            if [[ "$BASENAME" =~ ^W[0-9]+_.+\.json$ ]]; then
              echo "OK: $BASENAME"
            else
              echo "::error file=$wf::File does not match naming convention W<N>_*.json"
              ERRORS=1
            fi
          done

          if [[ $ERRORS -eq 1 ]]; then
            exit 1
          fi
          echo "::endgroup::"

      - name: Check for hardcoded IPs
        run: |
          echo "::group::Hardcoded IP check"

          for wf in workflows/*.json; do
            [[ -f "$wf" ]] || continue
            MATCHES=$(grep -En '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' "$wf" || true)
            if [[ -n "$MATCHES" ]]; then
              echo "::warning file=$wf::Hardcoded IP address detected"
              echo "$MATCHES"
            fi
          done

          echo "::endgroup::"

      - name: Check for Execute Command nodes
        run: |
          echo "::group::Execute Command node check"

          for wf in workflows/*.json; do
            [[ -f "$wf" ]] || continue
            if jq -e '.nodes[] | select(.type | contains("executeCommand"))' "$wf" > /dev/null 2>&1; then
              echo "::warning file=$wf::Contains Execute Command node - review for security"
            fi
          done

          echo "::endgroup::"
