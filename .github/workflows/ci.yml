name: CI Pipeline

on:
  push:
    branches: [main, develop, 'release/*']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  POSTGRES_USER: n8n
  POSTGRES_PASSWORD: n8npass
  POSTGRES_DB: n8n
  REDIS_URL: redis://localhost:6379

jobs:
  # ==========================================================================
  # JOB 1: Lint & Validate
  # ==========================================================================
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JSON files
        run: |
          echo "Validating workflow JSON files..."
          ERRORS=0
          for f in workflows/*.json; do
            echo -n "Checking $f ... "
            # Use Node.js for reliable JSON parsing (handles various encodings)
            if node -e "JSON.parse(require('fs').readFileSync('$f', 'utf8'))" 2>/dev/null; then
              echo "OK"
            else
              echo "INVALID"
              ERRORS=$((ERRORS + 1))
            fi
          done
          if [ $ERRORS -gt 0 ]; then
            echo "::error::$ERRORS JSON files are invalid"
            exit 1
          fi
          echo "All $(($(ls workflows/*.json | wc -l))) JSON files valid"

      - name: Check for placeholder values
        run: |
          echo "Checking for unresolved placeholders..."
          # Only warn, don't fail - some TODOs are acceptable in development
          if grep -rE "CHANGE_ME|REPLACE_ME" --include="*.json" workflows/ 2>/dev/null; then
            echo "::warning::Found placeholder values that need replacing before production"
          else
            echo "No critical placeholders found"
          fi

      - name: Validate bash scripts
        run: |
          echo "Checking bash syntax..."
          for f in scripts/*.sh; do
            echo "Checking $f"
            bash -n "$f" || exit 1
          done
          echo "All scripts valid"

  # ==========================================================================
  # JOB 2: Unit Tests
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install jsonschema pytest

      - name: Run contract validation
        run: |
          if [ -f scripts/validate_contracts.py ]; then
            python3 scripts/validate_contracts.py
          fi

      - name: Run localization tests
        run: |
          if [ -f scripts/test_l10n_script_detection.py ]; then
            python3 scripts/test_l10n_script_detection.py
          fi

  # ==========================================================================
  # JOB 3: Integration Tests
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: n8n
          POSTGRES_PASSWORD: n8npass
          POSTGRES_DB: n8n
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run database migrations
        env:
          PGPASSWORD: n8npass
        run: |
          if [ -f db/bootstrap.sql ]; then
            psql -h localhost -U n8n -d n8n -f db/bootstrap.sql
          fi

      - name: Validate test scripts
        run: |
          chmod +x scripts/*.sh
          bash -n scripts/test_battery.sh
          bash -n scripts/test_e2e.sh

  # ==========================================================================
  # JOB 4: Docker Build
  # ==========================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate docker-compose files
        run: |
          for f in docker-compose*.yml docker/docker-compose*.yml; do
            if [ -f "$f" ]; then
              echo "Checking $f"
              docker compose -f "$f" config > /dev/null || true
            fi
          done

  # ==========================================================================
  # JOB 5: Security Scan
  # ==========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in code
        run: |
          if grep -rE "(password|secret|token)\s*=\s*['\"][^'\"]{8,}" --include="*.json" . 2>/dev/null | grep -v "example" | grep -v "CHANGE_ME"; then
            echo "WARNING: Potential hardcoded secrets"
          fi

      - name: Check .env not committed
        run: |
          if [ -f ".env" ] || [ -f "config/.env" ]; then
            echo "ERROR: .env file should not be committed!"
            exit 1
          fi

      - name: Validate nginx security
        run: |
          if [ -f infra/gateway/nginx.conf ]; then
            grep -q "X-Content-Type-Options" infra/gateway/nginx.conf && echo "OK: X-Content-Type-Options"
            grep -q "X-Frame-Options" infra/gateway/nginx.conf && echo "OK: X-Frame-Options"
            grep -q "server_tokens off" infra/gateway/nginx.conf && echo "OK: server_tokens off"
          fi

  # ==========================================================================
  # JOB 6: Deploy
  # ==========================================================================
  deploy-staging:
    name: Deploy Staging
    runs-on: ubuntu-latest
    needs: [integration-tests, docker-build, security-scan]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - name: Deploy
        run: echo "Deploy to staging - customize for your infra"

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: [integration-tests, docker-build, security-scan]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy
        run: echo "Deploy to production - customize for your infra"
      - name: Smoke tests
        run: echo "Run post-deploy smoke tests"
