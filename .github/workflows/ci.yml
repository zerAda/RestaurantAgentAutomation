name: CI - Resto Bot

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # JOB 1: Validation statique
  # ============================================
  validate:
    name: Validation & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install jsonschema pyyaml
          sudo apt-get update && sudo apt-get install -y jq

      - name: Bash syntax check
        run: |
          echo "=== Bash Syntax Check ==="
          bash -n scripts/*.sh
          echo "PASS"

      - name: Secret scan (CHANGE_ME)
        run: |
          echo "=== Secret Scan ==="
          if grep -R --line-number --fixed-string "CHANGE_ME" \
            --exclude-dir=docs --exclude-dir=patches --exclude-dir=.git \
            --exclude=integrity_gate.sh -- . 2>/dev/null | grep -v ".git"; then
            echo "FAIL: CHANGE_ME placeholder found"
            exit 1
          fi
          echo "PASS"

      - name: Workflow JSON validation
        run: |
          echo "=== Workflow JSON Validation ==="
          for wf in workflows/*.json; do
            jq -e '.name and (.nodes|type=="array") and (.connections|type=="object") and (.active|type=="boolean")' "$wf" >/dev/null \
              || { echo "FAIL: $wf"; exit 1; }
            echo "OK: $(basename $wf)"
          done

      - name: Inbound security gates check
        run: |
          echo "=== Inbound Security Gates ==="
          for wf in W1_IN_WA.json W2_IN_IG.json W3_IN_MSG.json; do
            echo "Checking workflows/$wf..."

            # ALLOW_QUERY_TOKEN gate
            code=$(jq -r '.nodes[] | select(.name=="B0 - Parse & Canonicalize") | .parameters.jsCode' "workflows/$wf")
            echo "$code" | grep -q "ALLOW_QUERY_TOKEN" || { echo "FAIL: ALLOW_QUERY_TOKEN missing in $wf"; exit 1; }

            # scopeOk enforcement
            jq -e '.nodes[] | select(.name=="B0 - Token OK?") | .parameters.conditions.boolean | map(.value1) | any(.=="={{$json._auth.scopeOk}}")' "workflows/$wf" >/dev/null \
              || { echo "FAIL: scopeOk missing in $wf"; exit 1; }

            # Contract gate
            jq -e '.nodes[] | select(.name=="B0 - Contract Valid?")' "workflows/$wf" >/dev/null \
              || { echo "FAIL: Contract gate missing in $wf"; exit 1; }

            echo "OK: $wf"
          done

      - name: JSON Schema tests
        run: |
          echo "=== JSON Schema Tests ==="
          python scripts/validate_contracts.py

      - name: L10N script detection tests
        run: |
          echo "=== L10N Tests ==="
          python scripts/test_l10n_script_detection.py

      - name: Template rendering tests
        run: |
          echo "=== Template Tests ==="
          python scripts/test_template_render.py

      - name: Darija intent tests
        run: |
          echo "=== Darija Tests ==="
          python scripts/test_darja_intents.py

      - name: DB bootstrap order check
        run: |
          echo "=== DB Bootstrap Order ==="
          orders_line=$(grep -n "CREATE TABLE IF NOT EXISTS orders" db/bootstrap.sql | head -1 | cut -d: -f1)
          outbox_line=$(grep -n "CREATE TABLE IF NOT EXISTS outbound_messages" db/bootstrap.sql | head -1 | cut -d: -f1)
          if [[ $orders_line -lt $outbox_line ]]; then
            echo "PASS: orders (line $orders_line) before outbound_messages (line $outbox_line)"
          else
            echo "FAIL: orders must be before outbound_messages"
            exit 1
          fi

      - name: YAML compose validation
        run: |
          echo "=== YAML Validation ==="
          python -c "
          import yaml
          files = ['docker-compose.hostinger.prod.yml', 'docker/docker-compose.yml', 'docker/docker-compose.test.yml']
          for f in files:
              data = yaml.safe_load(open(f).read())
              assert 'services' in data, f'{f} missing services'
              print(f'OK: {f}')
          "

      - name: Security config check
        run: |
          echo "=== Security Config ==="
          for flag in LEGACY_SHARED_ALLOWED META_SIGNATURE_REQUIRED STRICT_AR_OUT ADMIN_WA_AUDIT_ENABLED; do
            grep -q "$flag" config/.env.example || { echo "FAIL: $flag missing"; exit 1; }
            echo "OK: $flag"
          done

  # ============================================
  # JOB 2: Build artifacts
  # ============================================
  build:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          echo "=== Creating deployment package ==="
          VERSION=$(cat VERSION)
          PACKAGE="resto-bot-${VERSION}-$(date +%Y%m%d-%H%M%S)"

          mkdir -p dist
          tar -czvf "dist/${PACKAGE}.tar.gz" \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='*.pdf' \
            --exclude='node_modules' \
            workflows/ \
            db/ \
            config/ \
            infra/ \
            scripts/ \
            templates/ \
            schemas/ \
            docker-compose.hostinger.prod.yml \
            VERSION

          echo "PACKAGE_NAME=${PACKAGE}" >> $GITHUB_ENV
          echo "Created: dist/${PACKAGE}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dist/*.tar.gz
          retention-days: 30
