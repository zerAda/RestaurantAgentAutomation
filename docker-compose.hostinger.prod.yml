services:
  traefik:
    image: traefik:v3.6.6
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.50"
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      - "--api.dashboard=true"
      - "--entrypoints.traefik.address=:8080"

      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.forwardedHeaders.trustedIPs=${TRAEFIK_TRUSTED_IPS}"
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=${TRAEFIK_TRUSTED_IPS}"

      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8080:8080"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./secrets/traefik_usersfile:/run/secrets/traefik_usersfile:ro
    networks: [ proxy ]
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.00"
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      TZ: ${TZ:-Europe/Paris}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      # DB initialization (runs only on fresh install)
      - ./db/bootstrap.sql:/docker-entrypoint-initdb.d/00_bootstrap.sql:ro
      - ./db/init/01_apply_migrations.sh:/docker-entrypoint-initdb.d/01_apply_migrations.sh:ro
      - ./db/init/02_create_strapi_db.sh:/docker-entrypoint-initdb.d/02_create_strapi_db.sh:ro
      - ./db/migrations:/docker-entrypoint-initdb.d/migrations:ro
    # Performance tuning
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=768MB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "log_statement=none"
      - "-c"
      - "log_min_duration_statement=1000"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U n8n -d n8n || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks: [ internal ]
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 384M
          cpus: "0.50"
    command: [ "redis-server", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru" ]
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [ internal ]
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  # ===========================================================================
  # DB Migrate - Apply pending migrations on startup (P0-01)
  # ===========================================================================
  # This service runs ONCE on each deployment to apply any pending migrations.
  # It's essential for UPGRADES where docker-entrypoint-initdb.d doesn't run.
  # Fail-fast: if migrations fail, this service exits with error, blocking n8n start.
  db-migrate:
    image: postgres:15-alpine
    depends_on:
      postgres: { condition: service_healthy }
    environment:
      PGHOST: postgres
      PGUSER: n8n
      PGPASSWORD_FILE: /run/secrets/postgres_password
      PGDATABASE: n8n
    volumes:
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./db/migrations:/migrations:ro
    entrypoint: [ "/bin/sh", "-c" ]
    command:
      - |
        set -e
        # Read password from file
        export PGPASSWORD=$$(cat /run/secrets/postgres_password)

        echo "=== DB Migration Service (P0-01) ==="
        echo "Waiting for postgres..."

        # Wait for postgres
        until pg_isready -h postgres -U n8n -d n8n; do
          sleep 1
        done

        echo "Postgres ready. Creating schema_migrations table..."

        # Create tracking table
        psql -v ON_ERROR_STOP=1 <<'EOSQL'
        CREATE TABLE IF NOT EXISTS schema_migrations (
          id          serial PRIMARY KEY,
          filename    text NOT NULL UNIQUE,
          applied_at  timestamptz NOT NULL DEFAULT now(),
          checksum    text NULL
        );
        EOSQL

        echo "Checking for pending migrations..."

        # Get applied migrations
        APPLIED=$$(psql -t -A -c "SELECT filename FROM schema_migrations ORDER BY filename")

        PENDING=0
        APPLIED_COUNT=0

        # Apply each migration if not already applied
        for migration in $$(ls -1 /migrations/*.sql 2>/dev/null | sort); do
          filename=$$(basename "$$migration")

          if echo "$$APPLIED" | grep -qx "$$filename"; then
            APPLIED_COUNT=$$((APPLIED_COUNT + 1))
            continue
          fi

          echo "Applying: $$filename"
          psql -v ON_ERROR_STOP=1 < "$$migration"

          # Record migration
          psql -v ON_ERROR_STOP=1 -c "INSERT INTO schema_migrations (filename) VALUES ('$$filename')"

          echo "  -> Applied: $$filename"
          PENDING=$$((PENDING + 1))
        done

        echo ""
        echo "=== Migration Summary ==="
        echo "Already applied: $$APPLIED_COUNT"
        echo "Newly applied:   $$PENDING"
        echo "=== DB Migration Complete ==="
    networks: [ internal ]
    restart: "no"
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  # ===========================================================================
  # Adminer - Database Management UI
  # ===========================================================================
  adminer:
    image: adminer:4-standalone
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    depends_on:
      postgres: { condition: service_healthy }
    environment:
      ADMINER_DEFAULT_SERVER: postgres
      ADMINER_DESIGN: nette
    expose: [ "8080" ]
    networks: [ proxy, internal ]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Route
      - "traefik.http.routers.adminer.rule=Host(`adminer.${DOMAIN_NAME}`)"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls=true"
      - "traefik.http.routers.adminer.tls.certresolver=mytlschallenge"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"
      # Security: IP Allowlist + Basic Auth
      - "traefik.http.routers.adminer.middlewares=adminer-chain@docker"
      - "traefik.http.middlewares.adminer-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.adminer-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.adminer-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.adminer-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.adminer-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.adminer-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.adminer-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.adminer-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.adminer-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.adminer-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.adminer-headers.headers.permissionsPolicy=camera=(), microphone=(), geolocation=()"
      - "traefik.http.middlewares.adminer-chain.chain.middlewares=adminer-allowlist,adminer-auth,adminer-headers"
    logging:
      driver: "json-file"
      options: { max-size: "5m", max-file: "3" }

  # ===========================================================================
  # Inventory CMS (Strapi 5) - Menu & Inventory Management
  # ===========================================================================
  cms:
    build:
      context: ./inventory-cms
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.50"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:1337/_health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      postgres: { condition: service_healthy }
      db-migrate: { condition: service_completed_successfully }
    expose: [ "1337" ]
    networks: [ proxy, internal ]
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=1337
      - DATABASE_CLIENT=postgres
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=${STRAPI_DATABASE_NAME:-strapi}
      - DATABASE_USERNAME=${POSTGRES_USER:-n8n}
      - DATABASE_PASSWORD_FILE=/run/secrets/postgres_password
      - DATABASE_SSL=false
      - ADMIN_JWT_SECRET=${STRAPI_ADMIN_JWT_SECRET:?STRAPI_ADMIN_JWT_SECRET must be set}
      - JWT_SECRET=${STRAPI_JWT_SECRET:?STRAPI_JWT_SECRET must be set}
      - API_TOKEN_SALT=${STRAPI_API_TOKEN_SALT:?STRAPI_API_TOKEN_SALT must be set}
      - TRANSFER_TOKEN_SALT=${STRAPI_TRANSFER_TOKEN_SALT:?STRAPI_TRANSFER_TOKEN_SALT must be set}
      - ENCRYPTION_KEY=${STRAPI_ENCRYPTION_KEY:?STRAPI_ENCRYPTION_KEY must be set}
      - APP_KEYS=${STRAPI_APP_KEYS:?STRAPI_APP_KEYS must be set}
      - CORS_ORIGINS=https://admin.${DOMAIN_NAME},https://kiosk.${DOMAIN_NAME},https://cms.${DOMAIN_NAME}
    volumes:
      - cms_uploads:/app/public/uploads
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.cms.rule=Host(`cms.${DOMAIN_NAME}`)"
      - "traefik.http.routers.cms.entrypoints=websecure"
      - "traefik.http.routers.cms.tls=true"
      - "traefik.http.routers.cms.tls.certresolver=mytlschallenge"
      - "traefik.http.services.cms.loadbalancer.server.port=1337"
      # Security: IP Allowlist + Basic Auth (same as admin tools)
      - "traefik.http.routers.cms.middlewares=cms-chain@docker"
      - "traefik.http.middlewares.cms-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.cms-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.cms-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.cms-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.cms-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.cms-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.cms-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.cms-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.cms-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.cms-chain.chain.middlewares=cms-allowlist,cms-headers"
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  # ===========================================================================
  # Admin Dashboard - React SPA
  # ===========================================================================
  admin-dashboard:
    build:
      context: .
      dockerfile: admin-dashboard/Dockerfile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    expose: [ "80" ]
    networks: [ proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.admin-dash.rule=Host(`admin.${DOMAIN_NAME}`)"
      - "traefik.http.routers.admin-dash.entrypoints=websecure"
      - "traefik.http.routers.admin-dash.tls=true"
      - "traefik.http.routers.admin-dash.tls.certresolver=mytlschallenge"
      - "traefik.http.services.admin-dash.loadbalancer.server.port=80"
      # Security: IP Allowlist + Basic Auth
      - "traefik.http.routers.admin-dash.middlewares=admin-dash-chain@docker"
      - "traefik.http.middlewares.admin-dash-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.admin-dash-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.admin-dash-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.admin-dash-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.admin-dash-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.admin-dash-chain.chain.middlewares=admin-dash-allowlist,admin-dash-auth,admin-dash-headers"
    logging:
      driver: "json-file"
      options: { max-size: "5m", max-file: "3" }

  # ===========================================================================
  # Kiosk App - Customer-facing React SPA
  # ===========================================================================
  kiosk-app:
    build:
      context: .
      dockerfile: kiosk-app/Dockerfile
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    expose: [ "80" ]
    networks: [ proxy ]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.routers.kiosk.rule=Host(`kiosk.${DOMAIN_NAME}`)"
      - "traefik.http.routers.kiosk.entrypoints=websecure"
      - "traefik.http.routers.kiosk.tls=true"
      - "traefik.http.routers.kiosk.tls.certresolver=mytlschallenge"
      - "traefik.http.services.kiosk.loadbalancer.server.port=80"
      # Public-facing â€“ rate limit + security headers only (no IP allowlist)
      - "traefik.http.routers.kiosk.middlewares=kiosk-chain@docker"
      - "traefik.http.middlewares.kiosk-ratelimit.ratelimit.average=30"
      - "traefik.http.middlewares.kiosk-ratelimit.ratelimit.burst=60"
      - "traefik.http.middlewares.kiosk-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.kiosk-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.kiosk-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.kiosk-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.kiosk-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.kiosk-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.kiosk-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.kiosk-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.kiosk-chain.chain.middlewares=kiosk-ratelimit,kiosk-headers"
    logging:
      driver: "json-file"
      options: { max-size: "5m", max-file: "3" }

  gateway:
    image: nginx:1.27-alpine
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/healthz || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    depends_on: [ n8n-main ]
    volumes:
      - ./infra/gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/gateway/proxy_params:/etc/nginx/proxy_params:ro
    expose: [ "8080" ]
    networks: [ proxy, internal ]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Public API (default)
      - "traefik.http.routers.resto-api.rule=Host(`${API_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.resto-api.entrypoints=websecure"
      - "traefik.http.routers.resto-api.tls=true"
      - "traefik.http.routers.resto-api.tls.certresolver=mytlschallenge"
      - "traefik.http.services.resto-api.loadbalancer.server.port=8080"
      - "traefik.http.routers.resto-api.middlewares=api-public-chain@docker"

      # Internal namespaces (higher priority)
      - "traefik.http.routers.resto-api-internal.rule=Host(`${API_SUBDOMAIN}.${DOMAIN_NAME}`) && (PathPrefix(`/v1/internal`) || PathPrefix(`/v1/admin`))"
      - "traefik.http.routers.resto-api-internal.priority=100"
      - "traefik.http.routers.resto-api-internal.entrypoints=websecure"
      - "traefik.http.routers.resto-api-internal.tls=true"
      - "traefik.http.routers.resto-api-internal.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.resto-api-internal.service=resto-api"
      - "traefik.http.routers.resto-api-internal.middlewares=api-internal-chain@docker"

      # Middlewares - Public chain
      - "traefik.http.middlewares.api-public-ratelimit.ratelimit.average=20"
      - "traefik.http.middlewares.api-public-ratelimit.ratelimit.burst=40"
      - "traefik.http.middlewares.api-public-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.api-public-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.api-public-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.api-public-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.api-public-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.api-public-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.api-public-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.api-public-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.api-public-chain.chain.middlewares=api-public-ratelimit,api-public-headers"

      # Middlewares - Internal chain
      - "traefik.http.middlewares.api-internal-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.api-internal-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.api-internal-chain.chain.middlewares=api-internal-allowlist,api-internal-auth,api-public-headers"
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  n8n-main:
    image: docker.n8n.io/n8nio/n8n:${N8N_VERSION}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.00"
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      db-migrate: { condition: service_completed_successfully }
    expose: [ "5678" ]
    networks: [ proxy, internal ]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Console/UI only (private)
      - "traefik.http.routers.resto-console.rule=Host(`${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.resto-console.entrypoints=websecure"
      - "traefik.http.routers.resto-console.tls=true"
      - "traefik.http.routers.resto-console.tls.certresolver=mytlschallenge"
      - "traefik.http.services.resto-console.loadbalancer.server.port=5678"
      - "traefik.http.routers.resto-console.middlewares=console-chain@docker"

      # Console middlewares
      - "traefik.http.middlewares.console-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.console-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.console-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.console-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.console-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.console-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.console-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.console-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.console-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.console-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.console-chain.chain.middlewares=console-allowlist,console-auth,console-headers"

    environment:
      - TZ=${TZ:-Europe/Paris}
      - GENERIC_TIMEZONE=${TZ:-Europe/Paris}
      - NODE_ENV=production

      # Console
      - N8N_HOST=${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_EDITOR_BASE_URL=https://${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}/

      # Webhooks (public)
      - WEBHOOK_URL=https://${API_SUBDOMAIN}.${DOMAIN_NAME}/

      # Reverse proxy chain: Traefik -> Gateway (for webhooks). Keep 2 hops.
      - N8N_PROXY_HOPS=2
      - N8N_SECURE_COOKIE=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false

      # Secrets
      - N8N_ENCRYPTION_KEY_FILE=/run/secrets/n8n_encryption_key

      # DB
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD_FILE=/run/secrets/postgres_password

      # Queue
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true

      # Pruning
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=50000

      # App env used in workflows (P0 Security)
      - WEBHOOK_SHARED_TOKEN=${WEBHOOK_SHARED_TOKEN:-}
      - LEGACY_SHARED_ALLOWED=${LEGACY_SHARED_ALLOWED:-false}
      - META_SIGNATURE_REQUIRED=${META_SIGNATURE_REQUIRED:-warn}
      - META_APP_SECRET=${META_APP_SECRET:-}
      - META_REPLAY_WINDOW_SEC=${META_REPLAY_WINDOW_SEC:-600}
      - STRICT_AR_OUT=${STRICT_AR_OUT:-true}
      - ADMIN_WA_AUDIT_ENABLED=${ADMIN_WA_AUDIT_ENABLED:-true}
      - RATE_LIMIT_PER_30S=${RATE_LIMIT_PER_30S:-6}
      - MENU_CACHE_TTL_SEC=${MENU_CACHE_TTL_SEC:-300}
      - ALLOWED_AUDIO_DOMAINS=${ALLOWED_AUDIO_DOMAINS:-cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com}
      - L10N_ENABLED=${L10N_ENABLED:-true}
      - L10N_STICKY_AR_ENABLED=${L10N_STICKY_AR_ENABLED:-true}
      - L10N_STICKY_AR_THRESHOLD=${L10N_STICKY_AR_THRESHOLD:-2}
      - L10N_FALLBACK_LOCALE=${L10N_FALLBACK_LOCALE:-fr}

      # Support (EPIC6)
      - SUPPORT_ENABLED=${SUPPORT_ENABLED:-true}
      - FAQ_ENABLED=${FAQ_ENABLED:-true}
      - ADMIN_WA_CONSOLE_ENABLED=${ADMIN_WA_CONSOLE_ENABLED:-true}
      - ADMIN_WA_CONSOLE_WORKFLOW_ID=${ADMIN_WA_CONSOLE_WORKFLOW_ID:-}
      - OUTBOX_MAX_ATTEMPTS=${OUTBOX_MAX_ATTEMPTS:-7}
      - OUTBOX_BASE_DELAY_SEC=${OUTBOX_BASE_DELAY_SEC:-30}
      - OUTBOX_MAX_DELAY_SEC=${OUTBOX_MAX_DELAY_SEC:-3600}

      # P1 Anti-fraud (EPIC7)
      - FRAUD_INBOUND_ENABLED=${FRAUD_INBOUND_ENABLED:-true}
      - FRAUD_CHECKOUT_ENABLED=${FRAUD_CHECKOUT_ENABLED:-true}
      - QUARANTINE_RELEASE_INTERVAL_SEC=${QUARANTINE_RELEASE_INTERVAL_SEC:-60}
      - FRAUD_FLOOD_LIMIT_30S=${FRAUD_FLOOD_LIMIT_30S:-6}
      - FRAUD_FLOOD_QUARANTINE_MIN=${FRAUD_FLOOD_QUARANTINE_MIN:-10}
      - FRAUD_HIGH_ORDER_THRESHOLD=${FRAUD_HIGH_ORDER_THRESHOLD:-3000000}
      - FRAUD_CANCEL_LIMIT=${FRAUD_CANCEL_LIMIT:-3}
      - FRAUD_CANCEL_WINDOW_DAYS=${FRAUD_CANCEL_WINDOW_DAYS:-7}

      # P1 Payments Algeria
      - PAYMENT_COD_ENABLED=${PAYMENT_COD_ENABLED:-true}
      - PAYMENT_DEPOSIT_ENABLED=${PAYMENT_DEPOSIT_ENABLED:-true}
      - PAYMENT_CIB_ENABLED=${PAYMENT_CIB_ENABLED:-false}
      - PAYMENT_EDAHABIA_ENABLED=${PAYMENT_EDAHABIA_ENABLED:-false}
      - PAYMENT_DEPOSIT_MODE=${PAYMENT_DEPOSIT_MODE:-PERCENTAGE}
      - PAYMENT_DEPOSIT_PERCENTAGE=${PAYMENT_DEPOSIT_PERCENTAGE:-30}
      - PAYMENT_DEPOSIT_THRESHOLD=${PAYMENT_DEPOSIT_THRESHOLD:-300000}
      - PAYMENT_COD_MAX_AMOUNT=${PAYMENT_COD_MAX_AMOUNT:-1000000}
      - PAYMENT_TRUST_MIN_ORDERS=${PAYMENT_TRUST_MIN_ORDERS:-3}
      - PAYMENT_TRUST_MIN_SCORE=${PAYMENT_TRUST_MIN_SCORE:-70}
      - PAYMENT_DEPOSIT_TIMEOUT_MIN=${PAYMENT_DEPOSIT_TIMEOUT_MIN:-30}

      # P0-04: Outbound URLs - NO DEFAULTS (mock-api removed)
      # CRITICAL: These MUST be configured in .env for production
      # Failure to configure = docker compose will fail to start (not silently lost)
      - WA_SEND_URL=${WA_SEND_URL:?WA_SEND_URL must be set for production}
      - WA_API_TOKEN=${WA_API_TOKEN:?WA_API_TOKEN must be set for production}
      - IG_SEND_URL=${IG_SEND_URL:?IG_SEND_URL must be set for production}
      - IG_API_TOKEN=${IG_API_TOKEN:?IG_API_TOKEN must be set for production}
      - MSG_SEND_URL=${MSG_SEND_URL:?MSG_SEND_URL must be set for production}
      - MSG_API_TOKEN=${MSG_API_TOKEN:?MSG_API_TOKEN must be set for production}

      # STT is optional - empty = disabled
      - STT_API_URL=${STT_API_URL:-}
      - LLM_API_URL=${LLM_API_URL:-http://ollama:11434/api/chat}
      - LLM_MODEL=${LLM_MODEL:-llama3.1}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}

      # Contracts + SLO thresholds
      - SCHEMAS_ROOT=${SCHEMAS_ROOT:-/opt/resto/schemas}
      - SLO_WINDOW_MIN=${SLO_WINDOW_MIN:-15}
      - SLO_INBOUND_TO_OUTBOX_P95_MS=${SLO_INBOUND_TO_OUTBOX_P95_MS:-2000}
      - SLO_OUTBOX_PENDING_AGE_MAX_SEC=${SLO_OUTBOX_PENDING_AGE_MAX_SEC:-600}
      - SLO_DLQ_RATE_MAX=${SLO_DLQ_RATE_MAX:-0.05}
      - SLO_DLQ_COUNT_MAX=${SLO_DLQ_COUNT_MAX:-5}

      # Subworkflow mapping
      - CORE_WORKFLOW_ID=${CORE_WORKFLOW_ID:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./secrets/n8n_encryption_key:/run/secrets/n8n_encryption_key:ro
      - ./schemas:/opt/resto/schemas:ro
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  n8n-worker:
    image: docker.n8n.io/n8nio/n8n:${N8N_VERSION}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: "0.75"
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      db-migrate: { condition: service_completed_successfully }
    command: [ "worker" ]
    networks: [ internal ]
    environment:
      - TZ=${TZ:-Europe/Paris}
      - GENERIC_TIMEZONE=${TZ:-Europe/Paris}
      - NODE_ENV=production
      - N8N_ENCRYPTION_KEY_FILE=/run/secrets/n8n_encryption_key

      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD_FILE=/run/secrets/postgres_password

      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_MAX_CONCURRENCY=${QUEUE_BULL_MAX_CONCURRENCY:-2}

      # App env used in workflows (P0 Security - Worker)
      - WEBHOOK_SHARED_TOKEN=${WEBHOOK_SHARED_TOKEN:-}
      - LEGACY_SHARED_ALLOWED=${LEGACY_SHARED_ALLOWED:-false}
      - META_SIGNATURE_REQUIRED=${META_SIGNATURE_REQUIRED:-warn}
      - META_APP_SECRET=${META_APP_SECRET:-}
      - META_REPLAY_WINDOW_SEC=${META_REPLAY_WINDOW_SEC:-600}
      - STRICT_AR_OUT=${STRICT_AR_OUT:-true}
      - ADMIN_WA_AUDIT_ENABLED=${ADMIN_WA_AUDIT_ENABLED:-true}
      - RATE_LIMIT_PER_30S=${RATE_LIMIT_PER_30S:-6}
      - MENU_CACHE_TTL_SEC=${MENU_CACHE_TTL_SEC:-300}
      - ALLOWED_AUDIO_DOMAINS=${ALLOWED_AUDIO_DOMAINS:-cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com}
      - L10N_ENABLED=${L10N_ENABLED:-true}
      - L10N_STICKY_AR_ENABLED=${L10N_STICKY_AR_ENABLED:-true}
      - L10N_STICKY_AR_THRESHOLD=${L10N_STICKY_AR_THRESHOLD:-2}
      - L10N_FALLBACK_LOCALE=${L10N_FALLBACK_LOCALE:-fr}

      # Support (EPIC6)
      - SUPPORT_ENABLED=${SUPPORT_ENABLED:-true}
      - FAQ_ENABLED=${FAQ_ENABLED:-true}
      - ADMIN_WA_CONSOLE_ENABLED=${ADMIN_WA_CONSOLE_ENABLED:-true}
      - ADMIN_WA_CONSOLE_WORKFLOW_ID=${ADMIN_WA_CONSOLE_WORKFLOW_ID:-}
      - OUTBOX_MAX_ATTEMPTS=${OUTBOX_MAX_ATTEMPTS:-7}
      - OUTBOX_BASE_DELAY_SEC=${OUTBOX_BASE_DELAY_SEC:-30}
      - OUTBOX_MAX_DELAY_SEC=${OUTBOX_MAX_DELAY_SEC:-3600}

      # P1 Anti-fraud (EPIC7 - Worker)
      - FRAUD_INBOUND_ENABLED=${FRAUD_INBOUND_ENABLED:-true}
      - FRAUD_CHECKOUT_ENABLED=${FRAUD_CHECKOUT_ENABLED:-true}
      - QUARANTINE_RELEASE_INTERVAL_SEC=${QUARANTINE_RELEASE_INTERVAL_SEC:-60}
      - FRAUD_FLOOD_LIMIT_30S=${FRAUD_FLOOD_LIMIT_30S:-6}
      - FRAUD_HIGH_ORDER_THRESHOLD=${FRAUD_HIGH_ORDER_THRESHOLD:-3000000}

      # P1 Payments Algeria (Worker)
      - PAYMENT_COD_ENABLED=${PAYMENT_COD_ENABLED:-true}
      - PAYMENT_DEPOSIT_ENABLED=${PAYMENT_DEPOSIT_ENABLED:-true}
      - PAYMENT_DEPOSIT_PERCENTAGE=${PAYMENT_DEPOSIT_PERCENTAGE:-30}
      - PAYMENT_DEPOSIT_THRESHOLD=${PAYMENT_DEPOSIT_THRESHOLD:-300000}

      # P0-04: Outbound URLs - NO DEFAULTS (mock-api removed)
      # CRITICAL: These MUST be configured in .env for production
      # Failure to configure = docker compose will fail to start (not silently lost)
      - WA_SEND_URL=${WA_SEND_URL:?WA_SEND_URL must be set for production}
      - WA_API_TOKEN=${WA_API_TOKEN:?WA_API_TOKEN must be set for production}
      - IG_SEND_URL=${IG_SEND_URL:?IG_SEND_URL must be set for production}
      - IG_API_TOKEN=${IG_API_TOKEN:?IG_API_TOKEN must be set for production}
      - MSG_SEND_URL=${MSG_SEND_URL:?MSG_SEND_URL must be set for production}
      - MSG_API_TOKEN=${MSG_API_TOKEN:?MSG_API_TOKEN must be set for production}

      # STT is optional - empty = disabled
      - STT_API_URL=${STT_API_URL:-}
      - LLM_API_URL=${LLM_API_URL:-http://ollama:11434/api/chat}
      - LLM_MODEL=${LLM_MODEL:-llama3.1}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}

      # Contracts + SLO thresholds
      - SCHEMAS_ROOT=${SCHEMAS_ROOT:-/opt/resto/schemas}
      - SLO_WINDOW_MIN=${SLO_WINDOW_MIN:-15}
      - SLO_INBOUND_TO_OUTBOX_P95_MS=${SLO_INBOUND_TO_OUTBOX_P95_MS:-2000}
      - SLO_OUTBOX_PENDING_AGE_MAX_SEC=${SLO_OUTBOX_PENDING_AGE_MAX_SEC:-600}
      - SLO_DLQ_RATE_MAX=${SLO_DLQ_RATE_MAX:-0.05}
      - SLO_DLQ_COUNT_MAX=${SLO_DLQ_COUNT_MAX:-5}

      - CORE_WORKFLOW_ID=${CORE_WORKFLOW_ID:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./secrets/n8n_encryption_key:/run/secrets/n8n_encryption_key:ro
      - ./schemas:/opt/resto/schemas:ro
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  ollama:
    image: ollama/ollama:0.6.2
    profiles: [ "ai" ]
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    networks: [ internal ]
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

  mock-api:
    build:
      context: ./mock-api
    profiles: [ "dev" ]
    restart: unless-stopped
    expose: [ "8080" ]
    networks: [ internal ]
    logging:
      driver: "json-file"
      options: { max-size: "10m", max-file: "5" }

networks:
  proxy:
    name: proxy
  internal:
    name: internal

volumes:
  traefik_data:
    external: true
  n8n_data:
    external: true
  postgres_data:
    external: true
  redis_data:
    external: true
  cms_uploads:
    external: true
  ollama_data:
    external: true
