version: "3.8"

services:
  traefik:
    image: traefik:v3.6.6
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"

      - "--api.dashboard=true"
      - "--entrypoints.traefik.address=:8080"

      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.forwardedHeaders.trustedIPs=${TRAEFIK_TRUSTED_IPS}"
      - "--entrypoints.websecure.forwardedHeaders.trustedIPs=${TRAEFIK_TRUSTED_IPS}"

      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
      - "127.0.0.1:8080:8080"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./secrets/traefik_usersfile:/run/secrets/traefik_usersfile:ro
    networks: [proxy]
    logging:
      options: { max-size: "10m", max-file: "5" }

  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      TZ: ${TZ:-Europe/Paris}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./db/bootstrap.sql:/docker-entrypoint-initdb.d/00_bootstrap.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n -d n8n || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks: [internal]
    logging:
      options: { max-size: "10m", max-file: "5" }

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [internal]
    logging:
      options: { max-size: "10m", max-file: "5" }

  gateway:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on: [n8n-main]
    volumes:
      - ./infra/gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/gateway/proxy_params:/etc/nginx/proxy_params:ro
    expose: ["8080"]
    networks: [proxy, internal]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Public API (default)
      - "traefik.http.routers.resto-api.rule=Host(`${API_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.resto-api.entrypoints=websecure"
      - "traefik.http.routers.resto-api.tls=true"
      - "traefik.http.routers.resto-api.tls.certresolver=mytlschallenge"
      - "traefik.http.services.resto-api.loadbalancer.server.port=8080"
      - "traefik.http.routers.resto-api.middlewares=api-public-chain@docker"

      # Internal namespaces (higher priority)
      - "traefik.http.routers.resto-api-internal.rule=Host(`${API_SUBDOMAIN}.${DOMAIN_NAME}`) && (PathPrefix(`/v1/internal`) || PathPrefix(`/v1/admin`))"
      - "traefik.http.routers.resto-api-internal.priority=100"
      - "traefik.http.routers.resto-api-internal.entrypoints=websecure"
      - "traefik.http.routers.resto-api-internal.tls=true"
      - "traefik.http.routers.resto-api-internal.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.resto-api-internal.service=resto-api"
      - "traefik.http.routers.resto-api-internal.middlewares=api-internal-chain@docker"

      # Middlewares - Public chain
      - "traefik.http.middlewares.api-public-ratelimit.ratelimit.average=20"
      - "traefik.http.middlewares.api-public-ratelimit.ratelimit.burst=40"
      - "traefik.http.middlewares.api-public-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.api-public-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.api-public-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.api-public-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.api-public-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.api-public-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.api-public-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.api-public-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.api-public-chain.chain.middlewares=api-public-ratelimit,api-public-headers"

      # Middlewares - Internal chain
      - "traefik.http.middlewares.api-internal-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.api-internal-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.api-internal-chain.chain.middlewares=api-internal-allowlist,api-internal-auth,api-public-headers"

  n8n-main:
    image: docker.n8n.io/n8nio/n8n:${N8N_VERSION}
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    expose: ["5678"]
    networks: [proxy, internal]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"

      # Console/UI only (private)
      - "traefik.http.routers.resto-console.rule=Host(`${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.resto-console.entrypoints=websecure"
      - "traefik.http.routers.resto-console.tls=true"
      - "traefik.http.routers.resto-console.tls.certresolver=mytlschallenge"
      - "traefik.http.services.resto-console.loadbalancer.server.port=5678"
      - "traefik.http.routers.resto-console.middlewares=console-chain@docker"

      # Console middlewares
      - "traefik.http.middlewares.console-allowlist.ipallowlist.sourcerange=${ADMIN_ALLOWED_IPS}"
      - "traefik.http.middlewares.console-auth.basicauth.usersfile=/run/secrets/traefik_usersfile"
      - "traefik.http.middlewares.console-headers.headers.browserXSSFilter=true"
      - "traefik.http.middlewares.console-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.console-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.console-headers.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.console-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.console-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.console-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.console-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.console-chain.chain.middlewares=console-allowlist,console-auth,console-headers"

    environment:
      - TZ=${TZ:-Europe/Paris}
      - GENERIC_TIMEZONE=${TZ:-Europe/Paris}
      - NODE_ENV=production

      # Console
      - N8N_HOST=${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_EDITOR_BASE_URL=https://${CONSOLE_SUBDOMAIN}.${DOMAIN_NAME}/

      # Webhooks (public)
      - WEBHOOK_URL=https://${API_SUBDOMAIN}.${DOMAIN_NAME}/

      # Reverse proxy chain: Traefik -> Gateway (for webhooks). Keep 2 hops.
      - N8N_PROXY_HOPS=2
      - N8N_SECURE_COOKIE=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false

      # Secrets
      - N8N_ENCRYPTION_KEY_FILE=/run/secrets/n8n_encryption_key

      # DB
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD_FILE=/run/secrets/postgres_password

      # Queue
      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true

      # Pruning
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
      - EXECUTIONS_DATA_PRUNE_MAX_COUNT=50000

      # App env used in workflows (P0 Security)
      - WEBHOOK_SHARED_TOKEN=${WEBHOOK_SHARED_TOKEN:-}
      - LEGACY_SHARED_ALLOWED=${LEGACY_SHARED_ALLOWED:-false}
      - META_SIGNATURE_REQUIRED=${META_SIGNATURE_REQUIRED:-false}
      - META_APP_SECRET=${META_APP_SECRET:-}
      - META_REPLAY_WINDOW_SEC=${META_REPLAY_WINDOW_SEC:-600}
      - STRICT_AR_OUT=${STRICT_AR_OUT:-true}
      - ADMIN_WA_AUDIT_ENABLED=${ADMIN_WA_AUDIT_ENABLED:-true}
      - RATE_LIMIT_PER_30S=${RATE_LIMIT_PER_30S:-6}
      - MENU_CACHE_TTL_SEC=${MENU_CACHE_TTL_SEC:-300}
      - ALLOWED_AUDIO_DOMAINS=${ALLOWED_AUDIO_DOMAINS:-cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com}
      - L10N_ENABLED=${L10N_ENABLED:-true}
      - L10N_STICKY_AR_ENABLED=${L10N_STICKY_AR_ENABLED:-true}
      - L10N_STICKY_AR_THRESHOLD=${L10N_STICKY_AR_THRESHOLD:-2}
      - L10N_FALLBACK_LOCALE=${L10N_FALLBACK_LOCALE:-fr}

      # Support (EPIC6)
      - SUPPORT_ENABLED=${SUPPORT_ENABLED:-true}
      - FAQ_ENABLED=${FAQ_ENABLED:-true}
      - ADMIN_WA_CONSOLE_ENABLED=${ADMIN_WA_CONSOLE_ENABLED:-true}
      - ADMIN_WA_CONSOLE_WORKFLOW_ID=${ADMIN_WA_CONSOLE_WORKFLOW_ID:-}
      - OUTBOX_MAX_ATTEMPTS=${OUTBOX_MAX_ATTEMPTS:-7}
      - OUTBOX_BASE_DELAY_SEC=${OUTBOX_BASE_DELAY_SEC:-30}
      - OUTBOX_MAX_DELAY_SEC=${OUTBOX_MAX_DELAY_SEC:-3600}

      # P1 Anti-fraud (EPIC7)
      - FRAUD_INBOUND_ENABLED=${FRAUD_INBOUND_ENABLED:-true}
      - FRAUD_CHECKOUT_ENABLED=${FRAUD_CHECKOUT_ENABLED:-true}
      - QUARANTINE_RELEASE_INTERVAL_SEC=${QUARANTINE_RELEASE_INTERVAL_SEC:-60}
      - FRAUD_FLOOD_LIMIT_30S=${FRAUD_FLOOD_LIMIT_30S:-6}
      - FRAUD_FLOOD_QUARANTINE_MIN=${FRAUD_FLOOD_QUARANTINE_MIN:-10}
      - FRAUD_HIGH_ORDER_THRESHOLD=${FRAUD_HIGH_ORDER_THRESHOLD:-3000000}
      - FRAUD_CANCEL_LIMIT=${FRAUD_CANCEL_LIMIT:-3}
      - FRAUD_CANCEL_WINDOW_DAYS=${FRAUD_CANCEL_WINDOW_DAYS:-7}

      # P1 Payments Algeria
      - PAYMENT_COD_ENABLED=${PAYMENT_COD_ENABLED:-true}
      - PAYMENT_DEPOSIT_ENABLED=${PAYMENT_DEPOSIT_ENABLED:-true}
      - PAYMENT_CIB_ENABLED=${PAYMENT_CIB_ENABLED:-false}
      - PAYMENT_EDAHABIA_ENABLED=${PAYMENT_EDAHABIA_ENABLED:-false}
      - PAYMENT_DEPOSIT_MODE=${PAYMENT_DEPOSIT_MODE:-PERCENTAGE}
      - PAYMENT_DEPOSIT_PERCENTAGE=${PAYMENT_DEPOSIT_PERCENTAGE:-30}
      - PAYMENT_DEPOSIT_THRESHOLD=${PAYMENT_DEPOSIT_THRESHOLD:-300000}
      - PAYMENT_COD_MAX_AMOUNT=${PAYMENT_COD_MAX_AMOUNT:-1000000}
      - PAYMENT_TRUST_MIN_ORDERS=${PAYMENT_TRUST_MIN_ORDERS:-3}
      - PAYMENT_TRUST_MIN_SCORE=${PAYMENT_TRUST_MIN_SCORE:-70}
      - PAYMENT_DEPOSIT_TIMEOUT_MIN=${PAYMENT_DEPOSIT_TIMEOUT_MIN:-30}

      - WA_SEND_URL=${WA_SEND_URL:-http://mock-api:8080/send/wa}
      - WA_API_TOKEN=${WA_API_TOKEN:-dev}
      - IG_SEND_URL=${IG_SEND_URL:-http://mock-api:8080/send/ig}
      - IG_API_TOKEN=${IG_API_TOKEN:-dev}
      - MSG_SEND_URL=${MSG_SEND_URL:-http://mock-api:8080/send/msg}
      - MSG_API_TOKEN=${MSG_API_TOKEN:-dev}

      - STT_API_URL=${STT_API_URL:-http://mock-api:8080/asr}
      - LLM_API_URL=${LLM_API_URL:-http://ollama:11434/api/chat}
      - LLM_MODEL=${LLM_MODEL:-llama3.1}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}

      # Contracts + SLO thresholds
      - SCHEMAS_ROOT=${SCHEMAS_ROOT:-/opt/resto/schemas}
      - SLO_WINDOW_MIN=${SLO_WINDOW_MIN:-15}
      - SLO_INBOUND_TO_OUTBOX_P95_MS=${SLO_INBOUND_TO_OUTBOX_P95_MS:-2000}
      - SLO_OUTBOX_PENDING_AGE_MAX_SEC=${SLO_OUTBOX_PENDING_AGE_MAX_SEC:-600}
      - SLO_DLQ_RATE_MAX=${SLO_DLQ_RATE_MAX:-0.05}
      - SLO_DLQ_COUNT_MAX=${SLO_DLQ_COUNT_MAX:-5}

      # Subworkflow mapping
      - CORE_WORKFLOW_ID=${CORE_WORKFLOW_ID:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./secrets/n8n_encryption_key:/run/secrets/n8n_encryption_key:ro
      - ./schemas:/opt/resto/schemas:ro
      - ./schemas:/opt/resto/schemas:ro
    logging:
      options: { max-size: "10m", max-file: "5" }

  n8n-worker:
    image: docker.n8n.io/n8nio/n8n:${N8N_VERSION}
    restart: unless-stopped
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    command: ["worker"]
    networks: [internal]
    environment:
      - TZ=${TZ:-Europe/Paris}
      - GENERIC_TIMEZONE=${TZ:-Europe/Paris}
      - NODE_ENV=production
      - N8N_ENCRYPTION_KEY_FILE=/run/secrets/n8n_encryption_key

      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=n8n
      - DB_POSTGRESDB_PASSWORD_FILE=/run/secrets/postgres_password

      - EXECUTIONS_MODE=queue
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=6379
      - QUEUE_BULL_MAX_CONCURRENCY=${QUEUE_BULL_MAX_CONCURRENCY:-2}

      # App env used in workflows (P0 Security - Worker)
      - WEBHOOK_SHARED_TOKEN=${WEBHOOK_SHARED_TOKEN:-}
      - LEGACY_SHARED_ALLOWED=${LEGACY_SHARED_ALLOWED:-false}
      - META_SIGNATURE_REQUIRED=${META_SIGNATURE_REQUIRED:-false}
      - META_APP_SECRET=${META_APP_SECRET:-}
      - META_REPLAY_WINDOW_SEC=${META_REPLAY_WINDOW_SEC:-600}
      - STRICT_AR_OUT=${STRICT_AR_OUT:-true}
      - ADMIN_WA_AUDIT_ENABLED=${ADMIN_WA_AUDIT_ENABLED:-true}
      - RATE_LIMIT_PER_30S=${RATE_LIMIT_PER_30S:-6}
      - MENU_CACHE_TTL_SEC=${MENU_CACHE_TTL_SEC:-300}
      - ALLOWED_AUDIO_DOMAINS=${ALLOWED_AUDIO_DOMAINS:-cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com}
      - L10N_ENABLED=${L10N_ENABLED:-true}
      - L10N_STICKY_AR_ENABLED=${L10N_STICKY_AR_ENABLED:-true}
      - L10N_STICKY_AR_THRESHOLD=${L10N_STICKY_AR_THRESHOLD:-2}
      - L10N_FALLBACK_LOCALE=${L10N_FALLBACK_LOCALE:-fr}

      # Support (EPIC6)
      - SUPPORT_ENABLED=${SUPPORT_ENABLED:-true}
      - FAQ_ENABLED=${FAQ_ENABLED:-true}
      - ADMIN_WA_CONSOLE_ENABLED=${ADMIN_WA_CONSOLE_ENABLED:-true}
      - ADMIN_WA_CONSOLE_WORKFLOW_ID=${ADMIN_WA_CONSOLE_WORKFLOW_ID:-}
      - OUTBOX_MAX_ATTEMPTS=${OUTBOX_MAX_ATTEMPTS:-7}
      - OUTBOX_BASE_DELAY_SEC=${OUTBOX_BASE_DELAY_SEC:-30}
      - OUTBOX_MAX_DELAY_SEC=${OUTBOX_MAX_DELAY_SEC:-3600}

      # P1 Anti-fraud (EPIC7 - Worker)
      - FRAUD_INBOUND_ENABLED=${FRAUD_INBOUND_ENABLED:-true}
      - FRAUD_CHECKOUT_ENABLED=${FRAUD_CHECKOUT_ENABLED:-true}
      - QUARANTINE_RELEASE_INTERVAL_SEC=${QUARANTINE_RELEASE_INTERVAL_SEC:-60}
      - FRAUD_FLOOD_LIMIT_30S=${FRAUD_FLOOD_LIMIT_30S:-6}
      - FRAUD_HIGH_ORDER_THRESHOLD=${FRAUD_HIGH_ORDER_THRESHOLD:-3000000}

      # P1 Payments Algeria (Worker)
      - PAYMENT_COD_ENABLED=${PAYMENT_COD_ENABLED:-true}
      - PAYMENT_DEPOSIT_ENABLED=${PAYMENT_DEPOSIT_ENABLED:-true}
      - PAYMENT_DEPOSIT_PERCENTAGE=${PAYMENT_DEPOSIT_PERCENTAGE:-30}
      - PAYMENT_DEPOSIT_THRESHOLD=${PAYMENT_DEPOSIT_THRESHOLD:-300000}

      - WA_SEND_URL=${WA_SEND_URL:-http://mock-api:8080/send/wa}
      - WA_API_TOKEN=${WA_API_TOKEN:-dev}
      - IG_SEND_URL=${IG_SEND_URL:-http://mock-api:8080/send/ig}
      - IG_API_TOKEN=${IG_API_TOKEN:-dev}
      - MSG_SEND_URL=${MSG_SEND_URL:-http://mock-api:8080/send/msg}
      - MSG_API_TOKEN=${MSG_API_TOKEN:-dev}

      - STT_API_URL=${STT_API_URL:-http://mock-api:8080/asr}
      - LLM_API_URL=${LLM_API_URL:-http://ollama:11434/api/chat}
      - LLM_MODEL=${LLM_MODEL:-llama3.1}
      - ALERT_WEBHOOK_URL=${ALERT_WEBHOOK_URL:-}

      # Contracts + SLO thresholds
      - SCHEMAS_ROOT=${SCHEMAS_ROOT:-/opt/resto/schemas}
      - SLO_WINDOW_MIN=${SLO_WINDOW_MIN:-15}
      - SLO_INBOUND_TO_OUTBOX_P95_MS=${SLO_INBOUND_TO_OUTBOX_P95_MS:-2000}
      - SLO_OUTBOX_PENDING_AGE_MAX_SEC=${SLO_OUTBOX_PENDING_AGE_MAX_SEC:-600}
      - SLO_DLQ_RATE_MAX=${SLO_DLQ_RATE_MAX:-0.05}
      - SLO_DLQ_COUNT_MAX=${SLO_DLQ_COUNT_MAX:-5}

      - CORE_WORKFLOW_ID=${CORE_WORKFLOW_ID:-}

    volumes:
      - n8n_data:/home/node/.n8n
      - ./secrets/postgres_password:/run/secrets/postgres_password:ro
      - ./secrets/n8n_encryption_key:/run/secrets/n8n_encryption_key:ro
      - ./schemas:/opt/resto/schemas:ro
      - ./schemas:/opt/resto/schemas:ro
    logging:
      options: { max-size: "10m", max-file: "5" }

  ollama:
    image: ollama/ollama:latest
    profiles: ["ai"]
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    networks: [internal]
    logging:
      options: { max-size: "10m", max-file: "3" }

  mock-api:
    build:
      context: ./mock-api
    profiles: ["dev"]
    restart: unless-stopped
    expose: ["8080"]
    networks: [internal]
    logging:
      options: { max-size: "10m", max-file: "3" }

networks:
  proxy:
    name: proxy
  internal:
    name: internal

volumes:
  traefik_data:
    external: true
  n8n_data:
    external: true
  postgres_data:
    external: true
  redis_data:
    external: true
  ollama_data:
    external: true
