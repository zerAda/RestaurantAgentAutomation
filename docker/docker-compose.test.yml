services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: n8n
      POSTGRES_USER: n8n
      POSTGRES_PASSWORD: n8npass
    ports:
      - "25432:5432"
    volumes:
      - test_postgres_data:/var/lib/postgresql/data
      - ../db/bootstrap.sql:/docker-entrypoint-initdb.d/00_bootstrap.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U n8n -d n8n"]
      interval: 5s
      timeout: 5s
      retries: 30

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "26379:6379"
    volumes:
      - test_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30

  n8n:
    image: n8nio/n8n:${N8N_VERSION:-1.80.0}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      TZ: ${TZ:-Europe/Paris}
      GENERIC_TIMEZONE: ${TZ:-Europe/Paris}
      N8N_BASIC_AUTH_ACTIVE: "false"
      N8N_DIAGNOSTICS_ENABLED: "false"
      N8N_PERSONALIZATION_ENABLED: "false"
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY:-dev_encryption_key_please_change_32chars_minimum_123456}

      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: n8n
      DB_POSTGRESDB_USER: n8n
      DB_POSTGRESDB_PASSWORD: n8npass

      # Queue (keep parity with prod)
      EXECUTIONS_MODE: queue
      QUEUE_BULL_REDIS_HOST: redis
      QUEUE_BULL_REDIS_PORT: 6379

      # App env used in workflows
      WEBHOOK_SHARED_TOKEN: ${WEBHOOK_SHARED_TOKEN:-test_shared_token}
      ALLOW_QUERY_TOKEN: "false"
      RATE_LIMIT_PER_30S: "6"
      SCHEMAS_ROOT: /opt/resto/schemas
      L10N_ENABLED: "true"
      L10N_STICKY_AR_ENABLED: "true"
      L10N_STICKY_AR_THRESHOLD: "2"

      # This is filled by the test harness after importing CORE (container is recreated)
      CORE_WORKFLOW_ID: ${CORE_WORKFLOW_ID:-}

      # Mock endpoints
      STT_API_URL: http://mock-api:8080/asr
      LLM_API_URL: http://mock-api:8080/llm
      WA_SEND_URL: http://mock-api:8080/send/wa
      IG_SEND_URL: http://mock-api:8080/send/ig
      MSG_SEND_URL: http://mock-api:8080/send/msg
      ALERT_WEBHOOK_URL: http://mock-api:8080/alert

      # Delivery feature flags (EPIC2)
      DELIVERY_ENABLED: "true"
      DELIVERY_SLOTS_ENABLED: "true"
      DELIVERY_ADDRESS_CLARIFY: "true"
      DELIVERY_DEFAULT_ETA_MIN: "45"
      DELIVERY_DEFAULT_ETA_MAX: "60"
      DELIVERY_FEE_MIN_CENTS: "0"
      DELIVERY_ADDRESS_MAX_ATTEMPTS: "3"

      # Support feature flags (EPIC6)
      SUPPORT_ENABLED: "true"
      FAQ_ENABLED: "true"
      ADMIN_WA_CONSOLE_ENABLED: "true"

      # Filled by the test harness after importing W14
      ADMIN_WA_CONSOLE_WORKFLOW_ID: ${ADMIN_WA_CONSOLE_WORKFLOW_ID:-}

    ports:
      - "25678:5678"
    volumes:
      - test_n8n_data:/home/node/.n8n
      - ../schemas:/opt/resto/schemas:ro
      - ../workflows:/opt/resto/workflows:ro
      - ../mock-api:/opt/resto/mock-api:ro

  gateway:
    image: nginx:1.27-alpine
    depends_on:
      - n8n
    ports:
      - "18080:8080"
    volumes:
      - ../infra/gateway/nginx.test.conf:/etc/nginx/conf.d/default.conf:ro
      - ../infra/gateway/proxy_params:/etc/nginx/proxy_params:ro

  mock-api:
    image: node:18-alpine
    working_dir: /app
    ports:
      - "18081:8080"
    volumes:
      - ../mock-api:/app
    command: sh -c "node server.js"

volumes:
  test_postgres_data:
  test_redis_data:
  test_n8n_data:
