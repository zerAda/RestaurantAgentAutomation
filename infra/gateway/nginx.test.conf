# RESTO BOT - Gateway (TEST)
# Same routes as prod but points to service name "n8n".

upstream n8n_upstream {
  server n8n:5678;
  keepalive 16;
}

server {
  listen 8080;

  location = /healthz {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  location = /v1/inbound/whatsapp {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/instagram {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/messenger {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  location = /v1/inbound/wa-incoming-v16 {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/ig-incoming-v16 {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/msg-incoming-v16 {
    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  location ^~ /v1/customer/ {
    proxy_pass http://n8n_upstream/webhook/v1/customer/;
    include /etc/nginx/proxy_params;
  }

  location ^~ /v1/internal/ {
    proxy_pass http://n8n_upstream/webhook/v1/internal/;
    include /etc/nginx/proxy_params;
  }
  location ^~ /v1/admin/ {
    proxy_pass http://n8n_upstream/webhook/v1/admin/;
    include /etc/nginx/proxy_params;
  }

  location / {
    return 404;
  }
}
