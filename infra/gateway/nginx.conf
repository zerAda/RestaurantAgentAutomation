# RESTO BOT v3.0 - Gateway (Nginx) - PATCHED P0-SEC-01
# Purpose: expose clean public API paths (/v1/...) and proxy to n8n internal webhooks (/webhook/...)
# This keeps n8n hidden behind the gateway and allows future refactors without breaking clients.
# 
# SECURITY PATCHES:
# - P0-SEC-01: Block query string tokens to prevent leakage in logs

upstream n8n_upstream {
  server n8n-main:5678;
  keepalive 32;
}

# Rate limiting zones (P0-SEC-05)
limit_req_zone $binary_remote_addr zone=inbound_ip:10m rate=10r/s;
limit_req_zone $http_x_api_token zone=inbound_token:10m rate=20r/s;

server {
  listen 8080;

  # ========================================
  # P0-SEC-01: Block query string tokens
  # Tokens in URLs leak to logs, referer headers, browser history
  # ========================================
  set $query_token_blocked 0;
  if ($arg_token) {
      set $query_token_blocked 1;
  }
  if ($arg_access_token) {
      set $query_token_blocked 1;
  }
  if ($arg_api_token) {
      set $query_token_blocked 1;
  }
  if ($arg_webhook_token) {
      set $query_token_blocked 1;
  }

  # Health endpoint (no auth here; protect at Traefik if needed)
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # -------- Public Inbound (stable API) with security checks
  location = /v1/inbound/whatsapp {
    # P0-SEC-01: Reject query tokens
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }
    # P0-SEC-05: Rate limiting
    limit_req zone=inbound_ip burst=20 nodelay;
    limit_req zone=inbound_token burst=50 nodelay;
    
    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }
  
  location = /v1/inbound/instagram {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }
    limit_req zone=inbound_ip burst=20 nodelay;
    limit_req zone=inbound_token burst=50 nodelay;
    
    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }
  
  location = /v1/inbound/messenger {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }
    limit_req zone=inbound_ip burst=20 nodelay;
    limit_req zone=inbound_token burst=50 nodelay;
    
    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  # -------- Aliases (legacy client compatibility) - also protected
  location = /v1/inbound/wa-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=inbound_ip burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/ig-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=inbound_ip burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/msg-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=inbound_ip burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  # -------- Reserved namespaces (private at Traefik)
  # These are designed for backoffice/ops. Implement the corresponding n8n workflows later.
  location ^~ /v1/customer/ {
    proxy_pass http://n8n_upstream/webhook/v1/customer/;
    include /etc/nginx/proxy_params;
  }
  location ^~ /v1/internal/ {
    proxy_pass http://n8n_upstream/webhook/v1/internal/;
    include /etc/nginx/proxy_params;
  }
  location ^~ /v1/admin/ {
    proxy_pass http://n8n_upstream/webhook/v1/admin/;
    include /etc/nginx/proxy_params;
  }

  # Default deny (avoid exposing random paths)
  location / {
    return 404;
  }
}
