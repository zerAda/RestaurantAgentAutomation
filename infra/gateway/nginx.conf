# RESTO BOT v3.1 - Gateway (Nginx) - HARDENED
# Purpose: expose clean public API paths (/v1/...) and proxy to n8n internal webhooks (/webhook/...)
# This keeps n8n hidden behind the gateway and allows future refactors without breaking clients.
#
# SECURITY PATCHES:
# - P0-SEC-01: Block query string tokens to prevent leakage in logs
# - P0-SEC-06: Hardening (body size, timeouts, methods, content-type, headers)

upstream n8n_upstream {
  server n8n-main:5678;
  keepalive 32;
}

# Rate limiting zones (P0-SEC-05)
# IMPORTANT: Meta webhooks do NOT send X-Api-Token header.
# Using $http_x_api_token as key would cause all Meta requests to share empty key = global throttle.
#
# Zone usage:
#   - meta_inbound: For /v1/inbound/* routes (Meta webhooks) - keyed by IP only
#   - internal_token: For /v1/internal/*, /v1/admin/*, /v1/customer/* - keyed by token (internal clients)
#   - conn_per_ip: Connection limit per IP (all routes)

# Meta inbound: rate limit by IP (Meta doesn't send custom tokens)
limit_req_zone $binary_remote_addr zone=meta_inbound:10m rate=10r/s;

# Internal API clients: rate limit by token (they DO send X-Api-Token)
limit_req_zone $http_x_api_token zone=internal_token:10m rate=20r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;

server {
  listen 8080;
  server_tokens off;  # Hide nginx version

  # ========================================
  # P0-SEC-06: Global hardening
  # ========================================

  # Max body size for webhooks (1MB should be enough for text messages)
  client_max_body_size 1m;

  # Timeouts (Meta expects response within 5s, we give buffer)
  proxy_connect_timeout 5s;
  proxy_send_timeout 10s;
  proxy_read_timeout 30s;

  # Connection limits per IP
  limit_conn conn_per_ip 50;

  # Security headers (applied to all responses)
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;
  add_header X-Permitted-Cross-Domain-Policies "none" always;
  add_header Cross-Origin-Opener-Policy "same-origin" always;
  add_header Cross-Origin-Resource-Policy "same-origin" always;

  # ========================================
  # P0-SEC-01: Block query string tokens
  # Tokens in URLs leak to logs, referer headers, browser history
  # ========================================
  set $query_token_blocked 0;
  if ($arg_token) {
      set $query_token_blocked 1;
  }
  if ($arg_access_token) {
      set $query_token_blocked 1;
  }
  if ($arg_api_token) {
      set $query_token_blocked 1;
  }
  if ($arg_webhook_token) {
      set $query_token_blocked 1;
  }

  # Health endpoint (no auth here; protect at Traefik if needed)
  location = /healthz {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # -------- Public Inbound (stable API) with security checks
  # Supports GET (Meta verify) and POST (events)
  location = /v1/inbound/whatsapp {
    # P0-SEC-06: Method allowlist (GET for verify, POST for events)
    limit_except GET POST {
      deny all;
    }

    # P0-SEC-01: Reject query tokens
    if ($query_token_blocked) {
        add_header Content-Type application/json always;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }

    # P0-SEC-06: Require JSON Content-Type on POST
    set $content_type_ok 1;
    if ($request_method = POST) {
      set $content_type_ok 0;
    }
    if ($http_content_type ~* "application/json") {
      set $content_type_ok 1;
    }
    if ($content_type_ok = 0) {
      add_header Content-Type application/json always;
      return 415 '{"error":"unsupported_media_type","code":"SEC-006","message":"Content-Type must be application/json"}';
    }

    # P0-SEC-05: Rate limiting (Meta inbound - by IP only, no token)
    # Meta does NOT send X-Api-Token, so we only limit by IP
    limit_req zone=meta_inbound burst=20 nodelay;

    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }

  location = /v1/inbound/instagram {
    limit_except GET POST {
      deny all;
    }

    if ($query_token_blocked) {
        add_header Content-Type application/json always;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }

    set $content_type_ok 1;
    if ($request_method = POST) {
      set $content_type_ok 0;
    }
    if ($http_content_type ~* "application/json") {
      set $content_type_ok 1;
    }
    if ($content_type_ok = 0) {
      add_header Content-Type application/json always;
      return 415 '{"error":"unsupported_media_type","code":"SEC-006","message":"Content-Type must be application/json"}';
    }

    # Rate limiting (Meta inbound - by IP only)
    limit_req zone=meta_inbound burst=20 nodelay;

    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }

  location = /v1/inbound/messenger {
    limit_except GET POST {
      deny all;
    }

    if ($query_token_blocked) {
        add_header Content-Type application/json always;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001","message":"Tokens must be sent via Authorization header"}';
    }

    set $content_type_ok 1;
    if ($request_method = POST) {
      set $content_type_ok 0;
    }
    if ($http_content_type ~* "application/json") {
      set $content_type_ok 1;
    }
    if ($content_type_ok = 0) {
      add_header Content-Type application/json always;
      return 415 '{"error":"unsupported_media_type","code":"SEC-006","message":"Content-Type must be application/json"}';
    }

    # Rate limiting (Meta inbound - by IP only)
    limit_req zone=meta_inbound burst=20 nodelay;

    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  # -------- Aliases (legacy client compatibility) - also protected
  location = /v1/inbound/wa-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=meta_inbound burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/whatsapp;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/ig-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=meta_inbound burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/instagram;
    include /etc/nginx/proxy_params;
  }
  location = /v1/inbound/msg-incoming-v16 {
    if ($query_token_blocked) {
        add_header Content-Type application/json;
        return 401 '{"error":"query_token_not_allowed","code":"SEC-001"}';
    }
    limit_req zone=meta_inbound burst=20 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/inbound/messenger;
    include /etc/nginx/proxy_params;
  }

  # -------- Reserved namespaces (private at Traefik)
  # These are designed for backoffice/ops. Implement the corresponding n8n workflows later.
  # Internal clients MUST send X-Api-Token header, so we rate limit by token.
  location ^~ /v1/customer/ {
    limit_req zone=internal_token burst=50 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/customer/;
    include /etc/nginx/proxy_params;
  }
  location ^~ /v1/internal/ {
    limit_req zone=internal_token burst=50 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/internal/;
    include /etc/nginx/proxy_params;
  }
  location ^~ /v1/admin/ {
    limit_req zone=internal_token burst=50 nodelay;
    proxy_pass http://n8n_upstream/webhook/v1/admin/;
    include /etc/nginx/proxy_params;
  }

  # Default deny (avoid exposing random paths)
  location / {
    return 404;
  }
}
