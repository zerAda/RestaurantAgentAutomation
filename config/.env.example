# =========================
# RESTO BOT v3.2.2 - ENV EXAMPLE
# =========================

# Domains
DOMAIN_NAME=example.com
CONSOLE_SUBDOMAIN=console
API_SUBDOMAIN=api

# TLS
SSL_EMAIL=you@example.com

# Timezone
TZ=Europe/Paris

# Reverse proxy trusted IPs (Traefik trusts X-Forwarded-For only from these IPs)
# Use public IPs of your LB / reverse proxy. Comma-separated CIDRs.
TRAEFIK_TRUSTED_IPS=203.0.113.10/32

# Allowlist for private console (comma-separated CIDRs). Use ONLY public /32 in prod.
ADMIN_ALLOWED_IPS=203.0.113.10/32

# Versions
N8N_VERSION=1.80.0

# =========================
# SECURITY (P0)
# =========================

# P0-SEC-03: Legacy shared token - DEPRECATED, leave EMPTY in production
# Use api_clients table + per-tenant token instead.
WEBHOOK_SHARED_TOKEN=

# P0-SEC-03: Kill-switch for legacy shared token
# Set to 'false' to block legacy token usage (recommended for production)
LEGACY_SHARED_ALLOWED=false

# P0-SEC-01: Allow tokens in query string (NOT recommended - tokens leak in logs)
# Default false. Set true only for legacy clients that cannot send headers.
ALLOW_QUERY_TOKEN=false

# P0-SEC-02: Meta/WhatsApp Signature Validation
# Mode: 'off' (disabled), 'warn' (log only), 'enforce' (reject invalid)
META_SIGNATURE_REQUIRED=false
META_APP_SECRET=
META_VERIFY_ENABLED=true
META_VERIFY_TOKEN=REPLACE_ME_META_VERIFY_TOKEN

# P0-SEC-02: Anti-replay protection
# Window in seconds to detect duplicate messages
META_REPLAY_WINDOW_SEC=600

# =========================
# RATE LIMITING
# =========================

# Workflow rate limit (per conversation) for inbound messages
RATE_LIMIT_PER_30S=6

# Queue concurrency
QUEUE_BULL_MAX_CONCURRENCY=2

# =========================
# LLM / STT / PROVIDERS
# =========================

LLM_API_URL=http://ollama:11434/api/chat
LLM_MODEL=llama3.1
STT_API_URL=http://mock-api:8080/asr

# Send adapters (dev defaults point to mock-api)
WA_SEND_URL=http://mock-api:8080/send/wa
WA_API_TOKEN=REPLACE_WITH_PROVIDER_TOKEN
IG_SEND_URL=http://mock-api:8080/send/ig
IG_API_TOKEN=REPLACE_WITH_PROVIDER_TOKEN
MSG_SEND_URL=http://mock-api:8080/send/msg
MSG_API_TOKEN=REPLACE_WITH_PROVIDER_TOKEN

# Alerts (optional)
ALERT_WEBHOOK_URL=


# SLO / Alerting thresholds
SLO_WINDOW_MIN=15
SLO_INBOUND_TO_OUTBOX_P95_MS=2000
SLO_OUTBOX_PENDING_AGE_MAX_SEC=600
SLO_DLQ_RATE_MAX=0.05
SLO_DLQ_COUNT_MAX=5
ALERT_COOLDOWN_SEC=300
ALERT_SLO_ENABLED=true
# After importing workflows, generate and set:
# CORE_WORKFLOW_ID=<n8n workflow id>
CORE_WORKFLOW_ID=

# Audio URL allowlist (comma-separated domains). Empty => block all audio STT.
ALLOWED_AUDIO_DOMAINS=cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com

# Outbox retry/backoff
OUTBOX_MAX_ATTEMPTS=7
OUTBOX_BASE_DELAY_SEC=30
OUTBOX_MAX_DELAY_SEC=3600

# =========================
# DB Retention (W8_OPS)
# =========================
RETENTION_DAYS_INBOUND=30
RETENTION_DAYS_SECURITY=90
RETENTION_DAYS_OUTBOX_SENT=30
RETENTION_DAYS_WORKFLOW_ERRORS=30
RETENTION_BATCH_SIZE=5000
RETENTION_MAX_ITERATIONS=200
RETENTION_DRY_RUN=false

# =========================
# LOCALIZATION (P0-L10N-01)
# =========================
# CRITICAL for Algeria: AR detection is ALWAYS active regardless of this flag
# This flag controls: sticky AR preference, LANG command, preference persistence
L10N_ENABLED=true

# Sticky AR: after N arabic messages, lock to AR until LANG FR
L10N_STICKY_AR_ENABLED=true
L10N_STICKY_AR_THRESHOLD=2

# Strict AR output: if input is Arabic, ALWAYS respond in Arabic
# Even if L10N_ENABLED=false, this ensures AR-in => AR-out
STRICT_AR_OUT=true

# Fallback locale when detection fails
L10N_FALLBACK_LOCALE=fr

# =========================
# Delivery (EPIC2)
# =========================
DELIVERY_ENABLED=false
DELIVERY_SLOTS_ENABLED=false
DELIVERY_ADDRESS_CLARIFY=true

# Defaults / guards
DELIVERY_DEFAULT_ETA_MIN=45
DELIVERY_DEFAULT_ETA_MAX=60
DELIVERY_FEE_MIN_CENTS=0
DELIVERY_ADDRESS_MAX_ATTEMPTS=3

# =========================
# EPIC6 Support (P2)
# =========================

# Human handoff (tickets)
SUPPORT_ENABLED=true

# FAQ RAG-light (DB full-text)
FAQ_ENABLED=true

# Admin piloting via WhatsApp (no UI)
ADMIN_WA_CONSOLE_ENABLED=true
ADMIN_WA_CONSOLE_WORKFLOW_ID=

# P0-OPS-01: Audit trail for Admin WA commands
ADMIN_WA_AUDIT_ENABLED=true

# =========================
# P1 - ANTI-FRAUD (EPIC7)
# =========================

# Enable fraud checks on inbound (spam/flood detection)
FRAUD_INBOUND_ENABLED=true

# Enable fraud checks on checkout (high order, repeat cancel)
FRAUD_CHECKOUT_ENABLED=true

# Quarantine auto-release job interval (W8_OPS)
QUARANTINE_RELEASE_INTERVAL_SEC=60

# Flood detection: max messages per 30s before throttle
FRAUD_FLOOD_LIMIT_30S=6

# Flood quarantine duration (minutes)
FRAUD_FLOOD_QUARANTINE_MIN=10

# High order threshold (centimes DZD) - triggers confirmation
FRAUD_HIGH_ORDER_THRESHOLD=3000000

# Repeat cancel limit before quarantine
FRAUD_CANCEL_LIMIT=3
FRAUD_CANCEL_WINDOW_DAYS=7

# =========================
# P1 - PAYMENTS ALGERIA
# =========================

# Enable payment features
PAYMENT_COD_ENABLED=true
PAYMENT_DEPOSIT_ENABLED=true
PAYMENT_CIB_ENABLED=false
PAYMENT_EDAHABIA_ENABLED=false

# Deposit settings
PAYMENT_DEPOSIT_MODE=PERCENTAGE
PAYMENT_DEPOSIT_PERCENTAGE=30
PAYMENT_DEPOSIT_THRESHOLD=300000

# COD limits
PAYMENT_COD_MAX_AMOUNT=1000000

# Trust thresholds (skip deposit for trusted customers)
PAYMENT_TRUST_MIN_ORDERS=3
PAYMENT_TRUST_MIN_SCORE=70

# Deposit payment timeout (minutes)
PAYMENT_DEPOSIT_TIMEOUT_MIN=30

# BaridiMob integration (future)
BARIDIMOB_MERCHANT_CODE=
BARIDIMOB_API_URL=
