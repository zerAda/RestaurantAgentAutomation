# ============================================================================
# RESTO BOT v3.2.4 - COMPLETE ENVIRONMENT CONFIGURATION
# ============================================================================
# This file contains ALL environment variables required for the system to work.
# Copy this file to .env and fill in the values appropriate for your environment.
#
# LEGEND:
#   [REQUIRED]  - Must be configured before running
#   [OPTIONAL]  - Has sensible defaults, configure if needed
#   [SECRET]    - Sensitive value, use Docker secrets in production
#   [FEATURE]   - Feature flag that enables/disables functionality
# ============================================================================

# ============================================================================
# 1. DOMAIN & NETWORK CONFIGURATION [REQUIRED]
# ============================================================================

# Primary domain for the application (e.g., restobot.example.com)
DOMAIN_NAME=example.com

# Subdomains for different services
CONSOLE_SUBDOMAIN=console
API_SUBDOMAIN=api

# Timezone (affects scheduling, logs, date formatting)
TZ=Europe/Paris

# ============================================================================
# 2. TLS / SSL CONFIGURATION [REQUIRED for Production]
# ============================================================================

# Email for Let's Encrypt ACME certificate registration
SSL_EMAIL=admin@example.com

# Traefik trusted proxy IPs (for X-Forwarded-* headers)
# Use your load balancer / reverse proxy public IPs (comma-separated CIDRs)
TRAEFIK_TRUSTED_IPS=127.0.0.1/32

# IP allowlist for admin console access (comma-separated CIDRs)
# Use your admin team's public IPs - NEVER use 0.0.0.0/0 in production
ADMIN_ALLOWED_IPS=127.0.0.1/32

# ============================================================================
# 3. N8N CONFIGURATION [REQUIRED]
# ============================================================================

# n8n container version
N8N_VERSION=1.80.0

# n8n UI authentication
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=CHANGE_ME_STRONG_PASSWORD_32CHARS   # [SECRET]

# n8n encryption key for credentials (MUST be 32+ characters)
N8N_ENCRYPTION_KEY=CHANGE_ME_ENCRYPTION_KEY_32_CHARS_MINIMUM_ABCDEF123456   # [SECRET]

# Public webhook URL (how external services reach n8n)
# In production: https://api.${DOMAIN_NAME}/webhook
WEBHOOK_URL=http://localhost:5678

# PostgreSQL credential ID in n8n (create this credential in n8n UI first)
# After creating, note the ID and set it here
N8N_DB_CREDENTIAL_ID=

# ============================================================================
# 4. WORKFLOW IDS [REQUIRED - Generate after importing workflows]
# ============================================================================
# After importing all workflows into n8n, run:
#   ./scripts/generate_workflow_ids.sh
# This will output the IDs to set below.

# Core orchestration workflow ID (W4_CORE)
CORE_WORKFLOW_ID=

# Admin WhatsApp console workflow ID (W14_ADMIN_WA_SUPPORT_CONSOLE)
ADMIN_WA_CONSOLE_WORKFLOW_ID=

# Redis helper workflow ID (W0_REDIS_HELPER) - for idempotence + rate-limiting
REDIS_HELPER_WORKFLOW_ID=

# ============================================================================
# 5. SECURITY CONFIGURATION [REQUIRED]
# ============================================================================

# ------------ P0-SEC-01: Query Token Control ------------
# Allow tokens in URL query string (NOT recommended - tokens leak in logs)
# Set to 'false' in production. Only 'true' for legacy clients that cannot send headers.
ALLOW_QUERY_TOKEN=false

# ------------ P0-SEC-02: Meta/WhatsApp/IG/Messenger Signature Validation ------------
# Mode for X-Hub-Signature-256 validation (applies to ALL 3 channels: WA/IG/MSG):
#   'off'     - Disabled, no signature check (dev only!)
#   'warn'    - Validate signature, log failures but allow through (staging/testing)
#   'enforce' - Reject requests with invalid/missing signature (PRODUCTION)
#   'true'    - Alias for 'enforce' (legacy compatibility)
#
# IMPORTANT: When set to 'warn' or 'enforce', valid Meta signature also serves
# as authentication for inbound webhooks (authMode='meta_signature').
# This is required because Meta does NOT send custom x-api-token headers.
#
# Recommended progression:
#   1. Start with 'off' during initial setup
#   2. Switch to 'warn' to validate without breaking traffic
#   3. Switch to 'enforce' once signature validation is confirmed working
META_SIGNATURE_REQUIRED=off

# Meta App Secret for webhook signature verification
META_APP_SECRET=   # [SECRET] Get this from Meta Developer Portal

# Meta webhook verification token (for initial webhook setup)
META_VERIFY_ENABLED=true
META_VERIFY_TOKEN=REPLACE_ME_META_VERIFY_TOKEN   # [SECRET]

# ------------ P0-04: Default Tenant for Meta Callbacks ------------
# When Meta sends webhooks (WA/IG/MSG), they don't include custom tokens.
# These defaults are used when auth is via Meta signature (META_SIGNATURE_REQUIRED=warn|enforce)
# For multi-tenant setups, configure per-restaurant webhooks with distinct tokens instead.
#
# [REQUIRED in Production] Set these to your actual tenant/restaurant UUIDs
DEFAULT_TENANT_ID=
DEFAULT_RESTAURANT_ID=

# [FEATURE] Enforce defaults in production (fail-fast if missing)
# Set to 'true' in production to ensure DEFAULT_TENANT_ID/DEFAULT_RESTAURANT_ID are configured
PROD_ENFORCE_DEFAULTS=false

# [FEATURE] Rollback flag - allow hardcoded fallback UUIDs (NOT recommended in production)
# Set to 'true' only during migration from old config. Remove after migration.
LEGACY_DEFAULT_IDS=false

# ------------ P0-08: Anti-replay protection ------------
# Enable/disable timestamp validation (default: true)
REPLAY_CHECK_ENABLED=true

# Anti-replay protection window in seconds (default: 300 = 5 min)
# Reject messages with timestamp older than this value
REPLAY_WINDOW_SECONDS=300

# P1-04: Payload-based anti-replay guard (Redis)
# Detects exact replay of same message payload
REPLAY_GUARD_ENABLED=true
REPLAY_GUARD_MODE=warn   # warn|enforce - enforce blocks replays, warn only logs
META_REPLAY_WINDOW_SEC=300   # TTL for replay keys (seconds)

# ------------ P0-SEC-03: Legacy Token Migration ------------
# Legacy shared token - DEPRECATED, leave EMPTY in production
# Use api_clients table + per-tenant token instead
WEBHOOK_SHARED_TOKEN=   # [SECRET] Leave empty in production

# Kill-switch for legacy shared token
# Set to 'false' to block ALL legacy token usage (recommended for production)
LEGACY_SHARED_ALLOWED=false

# ============================================================================
# 6. RATE LIMITING [OPTIONAL]
# ============================================================================

# Maximum inbound messages per conversation per 30 seconds
# Exceeding this triggers rate limiting response
RATE_LIMIT_PER_30S=6

# n8n queue worker concurrency
QUEUE_BULL_MAX_CONCURRENCY=2

# ============================================================================
# 7. DATABASE CONFIGURATION [REQUIRED for Production]
# ============================================================================

# PostgreSQL connection (used by scripts)
# Format: postgres://user:password@host:port/database
DATABASE_URL=postgres://n8n:n8npass@postgres:5432/n8n

# PostgreSQL credentials (used by Docker)
POSTGRES_USER=n8n
POSTGRES_PASSWORD=n8npass   # [SECRET]
POSTGRES_DB=n8n

# ============================================================================
# 8. REDIS CONFIGURATION [REQUIRED for Queue Mode]
# ============================================================================

# Redis host for n8n queue mode
QUEUE_BULL_REDIS_HOST=redis
QUEUE_BULL_REDIS_PORT=6379

# ------------ REDIS FOR RALPHE (Idempotence, Rate-Limit, Outbox, DLQ) ------------
# Redis URL for ralphe operations (format: redis://host:port or redis://user:pass@host:port)
# This is used by workflows for fast idempotence checks, rate limiting, and message queue
REDIS_URL=redis://redis:6379

# P0-06: Redis-based deduplication (fast idempotence)
# Set to 'false' to disable Redis dedupe and fallback to DB-only idempotence
DEDUPE_ENABLED=true

# Deduplication TTL in seconds (how long to remember msg_id to prevent replays)
# Default: 172800 (48 hours) - covers Meta's retry window with safety margin
DEDUPE_TTL_SEC=172800

# P1-02: Rate limiting toggle (set to 'false' to disable rate limiting)
RL_ENABLED=true

# Rate limit max requests per 30 seconds per conversation
# Uses sliding window in Redis + DB fallback
RL_MAX_PER_30S=6

# Outbox retry settings
OUTBOX_REDIS_TTL_SEC=604800

# P1-03: Async outbox mode (worker processes queue instead of sync send)
# Set to 'true' to enable async mode with W15 worker
OUTBOX_ASYNC_ENABLED=false

# P1-03: Outbox worker configuration
OUTBOX_WORKER_ENABLED=true
OUTBOX_WORKER_BATCH_SIZE=10

# DLQ (Dead Letter Queue) max age before alert
DLQ_ALERT_THRESHOLD=10

# ============================================================================
# 9. LLM / AI CONFIGURATION [OPTIONAL]
# ============================================================================

# LLM API endpoint (Ollama or compatible)
# Leave empty to disable LLM features (system will use rule-based routing)
LLM_API_URL=http://ollama:11434/api/chat

# LLM model name
LLM_MODEL=llama3.1

# ============================================================================
# 10. SPEECH-TO-TEXT (STT) CONFIGURATION [OPTIONAL]
# ============================================================================

# STT API endpoint (Whisper or compatible)
# Leave empty to disable voice message transcription
STT_API_URL=http://mock-api:8080/asr

# Audio URL allowlist for STT processing (comma-separated domains)
# IMPORTANT: If empty, ALL audio messages will be BLOCKED
# Include domains where WhatsApp/Meta stores audio files
ALLOWED_AUDIO_DOMAINS=cdn.fbsbx.com,lookaside.fbsbx.com,mmg.whatsapp.net,graph.facebook.com

# ============================================================================
# 11. MESSAGE PROVIDER APIS [REQUIRED]
# ============================================================================
# Configure endpoints and tokens for each messaging platform.
# For development, use mock-api. For production, use real provider URLs.

# Meta Graph API version for all channels (WA, IG, MSG)
# Update when Meta deprecates older versions (check Meta changelog)
GRAPH_API_VERSION=v21.0

# ------------ WhatsApp Business API (Cloud API) ------------
# Production URL: https://graph.facebook.com/v21.0/{PHONE_NUMBER_ID}/messages
# For dev/test: http://mock-api:8080/send/wa
# Replace {PHONE_NUMBER_ID} with your WhatsApp Business phone number ID
WA_SEND_URL=http://mock-api:8080/send/wa
WA_PHONE_NUMBER_ID=   # [REQUIRED for production] Your WhatsApp Phone Number ID
WA_API_TOKEN=REPLACE_WITH_WHATSAPP_TOKEN   # [SECRET] Permanent access token from Meta

# ------------ Instagram Messaging API ------------
# Production URL: https://graph.facebook.com/v21.0/{PAGE_ID}/messages (with PSID)
# For dev/test: http://mock-api:8080/send/ig
# Replace {PAGE_ID} with your Instagram-connected Facebook Page ID
IG_SEND_URL=http://mock-api:8080/send/ig
IG_PAGE_ID=   # [REQUIRED for production] Your Instagram-connected Page ID
IG_API_TOKEN=REPLACE_WITH_INSTAGRAM_TOKEN   # [SECRET] Page access token with instagram_basic, instagram_manage_messages

# ------------ Messenger API ------------
# Production URL: https://graph.facebook.com/v21.0/{PAGE_ID}/messages
# For dev/test: http://mock-api:8080/send/msg
# Replace {PAGE_ID} with your Facebook Page ID
MSG_SEND_URL=http://mock-api:8080/send/msg
MSG_PAGE_ID=   # [REQUIRED for production] Your Facebook Page ID
MSG_API_TOKEN=REPLACE_WITH_MESSENGER_TOKEN   # [SECRET] Page access token with pages_messaging

# ============================================================================
# 12. OUTBOX & MESSAGE RETRY [OPTIONAL]
# ============================================================================

# Maximum retry attempts for failed outbound messages
OUTBOX_MAX_ATTEMPTS=7

# Base delay for first retry (seconds)
OUTBOX_BASE_DELAY_SEC=30

# Maximum delay between retries (seconds) - caps exponential backoff
OUTBOX_MAX_DELAY_SEC=3600

# ============================================================================
# 13. ALERTING & MONITORING [OPTIONAL]
# ============================================================================

# Webhook URL for alerts (Slack, Discord, PagerDuty, etc.)
# Leave empty to disable external alerting
ALERT_WEBHOOK_URL=

# Enable SLO-based alerting
ALERT_SLO_ENABLED=true

# Alert cooldown to prevent spam (seconds)
ALERT_COOLDOWN_SEC=300

# P1-05: Health monitoring
HEALTH_MONITOR_ENABLED=true
HEALTH_ALERT_THRESHOLD=3        # Consecutive failures before alert
ADMIN_ALERT_PHONE=              # Admin phone number for WhatsApp alerts

# ============================================================================
# 14. SLO (Service Level Objectives) [OPTIONAL]
# ============================================================================

# Monitoring window for SLO calculations (minutes)
SLO_WINDOW_MIN=15

# P95 latency threshold: inbound message to outbox (milliseconds)
SLO_INBOUND_TO_OUTBOX_P95_MS=2000

# Maximum age for pending outbox messages before alert (seconds)
SLO_OUTBOX_PENDING_AGE_MAX_SEC=600

# Maximum DLQ (Dead Letter Queue) rate before alert (0.05 = 5%)
SLO_DLQ_RATE_MAX=0.05

# Maximum absolute DLQ count before alert
SLO_DLQ_COUNT_MAX=5

# ============================================================================
# 15. DATA RETENTION (W8_OPS) [OPTIONAL]
# ============================================================================
# Configure how long to keep various data types before purging.

# Inbound messages retention (days)
RETENTION_DAYS_INBOUND=30

# Security events retention (days)
RETENTION_DAYS_SECURITY=90

# Sent outbox messages retention (days)
RETENTION_DAYS_OUTBOX_SENT=30

# Workflow error logs retention (days)
RETENTION_DAYS_WORKFLOW_ERRORS=30

# Batch size for purge operations
RETENTION_BATCH_SIZE=5000

# Maximum iterations per purge run (safety limit)
RETENTION_MAX_ITERATIONS=200

# Dry run mode (true = log what would be deleted, don't actually delete)
RETENTION_DRY_RUN=false

# ============================================================================
# 16. LOCALIZATION (L10N) [FEATURE]
# ============================================================================
# Multi-language support for French and Arabic

# Enable localization features (LANG command, preference persistence)
# Note: Arabic script detection is ALWAYS active regardless of this setting
L10N_ENABLED=true

# Sticky Arabic mode: after N Arabic-script messages, lock session to Arabic
# until user sends "LANG FR"
L10N_STICKY_AR_ENABLED=true
L10N_STICKY_AR_THRESHOLD=2

# Strict Arabic output: if input contains Arabic script, ALWAYS respond in Arabic
# This guarantees AR-in => AR-out even if L10N_ENABLED=false
STRICT_AR_OUT=true

# Fallback locale when detection fails
L10N_FALLBACK_LOCALE=fr

# ============================================================================
# 17. DELIVERY FEATURE (EPIC2) [FEATURE]
# ============================================================================
# Restaurant delivery service configuration

# Enable delivery feature
DELIVERY_ENABLED=false

# Enable delivery time slot selection
DELIVERY_SLOTS_ENABLED=false

# Enable address clarification flow (multi-turn address collection)
DELIVERY_ADDRESS_CLARIFY=true

# Maximum address clarification attempts before handoff to human
DELIVERY_ADDRESS_MAX_ATTEMPTS=3

# Default ETA range when zone-specific ETA not configured (minutes)
DELIVERY_DEFAULT_ETA_MIN=45
DELIVERY_DEFAULT_ETA_MAX=60

# Minimum delivery fee (cents)
DELIVERY_FEE_MIN_CENTS=0

# ============================================================================
# 18. SUPPORT & FAQ (EPIC6) [FEATURE]
# ============================================================================
# Human support handoff and FAQ features

# Enable support ticket creation and handoff to human agents
SUPPORT_ENABLED=true

# Enable FAQ search (RAG-light with DB full-text search)
FAQ_ENABLED=true

# Enable admin console via WhatsApp (no web UI needed)
ADMIN_WA_CONSOLE_ENABLED=true

# Enable audit logging for admin WhatsApp commands
ADMIN_WA_AUDIT_ENABLED=true

# ============================================================================
# 19. ANTI-FRAUD (EPIC7) [FEATURE]
# ============================================================================
# Fraud detection and prevention

# Enable fraud checks on inbound messages (spam/flood detection)
FRAUD_INBOUND_ENABLED=true

# Enable fraud checks on checkout (high order value, repeat cancellations)
FRAUD_CHECKOUT_ENABLED=true

# Quarantine auto-release check interval (seconds)
QUARANTINE_RELEASE_INTERVAL_SEC=60

# Flood detection: max messages per 30 seconds before quarantine
FRAUD_FLOOD_LIMIT_30S=6

# Flood quarantine duration (minutes)
FRAUD_FLOOD_QUARANTINE_MIN=10

# High order threshold (cents DZD) - triggers confirmation step
# 3000000 cents = 30,000 DZD
FRAUD_HIGH_ORDER_THRESHOLD=3000000

# Repeat cancellation limit before quarantine
FRAUD_CANCEL_LIMIT=3
FRAUD_CANCEL_WINDOW_DAYS=7

# ============================================================================
# 20. PAYMENTS - ALGERIA (PAY01) [FEATURE]
# ============================================================================
# Payment methods configuration for Algerian market

# ------------ Payment Methods ------------
# Cash on Delivery
PAYMENT_COD_ENABLED=true
PAYMENT_COD_MAX_AMOUNT=1000000   # Max COD amount (cents) = 10,000 DZD

# Deposit payment (partial prepayment)
PAYMENT_DEPOSIT_ENABLED=true
PAYMENT_DEPOSIT_MODE=PERCENTAGE   # PERCENTAGE or FIXED
PAYMENT_DEPOSIT_PERCENTAGE=30     # 30% deposit
PAYMENT_DEPOSIT_THRESHOLD=300000  # Min order for deposit (cents) = 3,000 DZD
PAYMENT_DEPOSIT_TIMEOUT_MIN=30    # Minutes to complete deposit

# CIB (Carte Interbancaire) - Future
PAYMENT_CIB_ENABLED=false

# Edahabia (Alg√©rie Poste) - Future
PAYMENT_EDAHABIA_ENABLED=false

# ------------ Trust System ------------
# Trusted customers can skip deposit requirements
PAYMENT_TRUST_MIN_ORDERS=3        # Minimum completed orders for trust
PAYMENT_TRUST_MIN_SCORE=70        # Minimum trust score (0-100)

# ------------ BaridiMob Integration (Future) ------------
BARIDIMOB_MERCHANT_CODE=
BARIDIMOB_API_URL=

# ============================================================================
# 21. SCHEMAS & CONTRACTS [OPTIONAL]
# ============================================================================

# Path to JSON Schema files for contract validation
# Default: /opt/resto/schemas (mounted from project/schemas)
SCHEMAS_ROOT=/opt/resto/schemas

# ============================================================================
# 22. BACKUP CONFIGURATION [OPTIONAL]
# ============================================================================

# Backup directory for database dumps
BACKUP_DIR=./backups/postgres

# Backup retention (days)
BACKUP_RETENTION_DAYS=14

# ============================================================================
# 23. TESTING CONFIGURATION [DEV/TEST ONLY]
# ============================================================================
# These variables are used for testing and should NOT be set in production.

# Test tokens for smoke tests
# TEST_TOKEN=test-token-123
# INBOUND_TOKEN=test-token-inbound
# ADMIN_TOKEN=test-token-admin
# CUSTOMER_TOKEN=test-token-customer

# Rate limit burst for testing
# RATE_LIMIT_BURST=60

# Enable rate limit testing
# RUN_RATE_LIMIT_TEST=false

# ============================================================================
# 24. MENU CONFIGURATION [OPTIONAL]
# ============================================================================

# Menu cache TTL (seconds) - how long to cache menu data
MENU_CACHE_TTL_SEC=300

# ============================================================================
# 25. STRUCTURED LOGGING (P1-06) [OPTIONAL]
# ============================================================================
# Structured logging configuration for end-to-end tracing and observability.

# Log level: DEBUG | INFO | WARN | ERROR (default: INFO)
# DEBUG - All logs including detailed request/response data
# INFO  - Normal operations, request flow, important events
# WARN  - Recoverable issues, rate limits, retries
# ERROR - Failures, exceptions, critical issues
LOG_LEVEL=INFO

# Structured logging output format (default: true)
# true  - JSON format: {"timestamp":"...","correlation_id":"...","level":"...","message":"..."}
# false - Plain text format: [timestamp] [level] [correlation_id] message
LOG_STRUCTURED=true

# Secrets to mask in logs (comma-separated patterns)
# These patterns will be replaced with [REDACTED] in log output
LOG_MASK_PATTERNS=token,password,secret,api_key,authorization,x-api-token,x-webhook-token,bearer

# Correlation ID header name (default: x-correlation-id)
# If present in incoming request, it will be used; otherwise a new UUID is generated
CORRELATION_ID_HEADER=x-correlation-id

# ============================================================================
# END OF CONFIGURATION
# ============================================================================
# After configuring this file:
# 1. Copy to .env: cp config/.env.example .env
# 2. Edit .env with your actual values
# 3. Import workflows: Import all JSON files from workflows/ into n8n
# 4. Generate workflow IDs: ./scripts/generate_workflow_ids.sh
# 5. Update .env with workflow IDs
# 6. Enable workflows in n8n UI
# 7. Start the stack: docker compose -f docker-compose.hostinger.prod.yml up -d
# 8. Run smoke tests: ./scripts/smoke.sh
# ============================================================================
